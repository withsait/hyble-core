generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum UserStatus {
  ACTIVE
  SUSPENDED
  FROZEN
  PENDING_DELETION
}

enum TrustLevel {
  GUEST      // Level 0: Unverified
  VERIFIED   // Level 1: Email verified
  SECURE     // Level 2: 2FA enabled
  CORPORATE  // Level 3: Corporate verified
}

enum Platform {
  HYBLE
  MINEBLE
  BOTH
}

enum AddressType {
  HOME
  WORK
  BILLING
  SHIPPING
  OTHER
}

enum SecurityAction {
  LOGIN
  LOGOUT
  REGISTER
  PASSWORD_CHANGE
  PASSWORD_RESET_REQUEST
  PASSWORD_RESET
  EMAIL_CHANGE
  EMAIL_VERIFIED
  PHONE_CHANGE
  TWO_FACTOR_ENABLE
  TWO_FACTOR_DISABLE
  TWO_FACTOR_VERIFY
  BACKUP_CODE_USED
  ACCOUNT_LOCK
  ACCOUNT_UNLOCK
  ACCOUNT_FREEZE
  ACCOUNT_UNFREEZE
  ACCOUNT_DELETE_REQUEST
  ACCOUNT_DELETE_CANCEL
  SESSION_REVOKE
  SESSION_REVOKE_ALL
  DEVICE_TRUST
  DEVICE_UNTRUST
  API_KEY_CREATE
  API_KEY_REVOKE
  API_KEY_UPDATE
  API_KEY_REGENERATE
  OAUTH_CONNECT
  OAUTH_DISCONNECT
  ORG_CREATE
  ORG_JOIN
  ORG_LEAVE
  ORG_INVITE_SEND
  ORG_INVITE_ACCEPT
  ORG_MEMBER_ROLE_CHANGE
  ORG_MEMBER_REMOVE
  IMPERSONATION_START
  IMPERSONATION_END
  ACCOUNT_BAN
  ACCOUNT_UNBAN
  ADMIN_IMPERSONATION
  GHOST_ACCOUNT_CLEANUP
}

enum SecurityStatus {
  SUCCESS
  FAILURE
  BLOCKED
}

enum OrganizationRole {
  OWNER
  ADMIN
  MANAGER
  MEMBER
  BILLING
  VIEWER
}

enum InviteStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
  CANCELLED
}

enum BanType {
  TEMPORARY    // Temporary suspension
  PERMANENT    // Permanent termination
  SHADOW       // Shadow ban (user doesn't know)
}

enum CalendarEventType {
  BIRTHDAY
  ANNIVERSARY
  COMPANY_FOUNDING
  PARTNERSHIP_ANNIVERSARY
}

enum AccountDeletionStatus {
  PENDING
  PROCESSING
  COMPLETED
  CANCELLED
}

// ==================== USER ====================

model User {
  id              String     @id @default(cuid())
  email           String     @unique
  name            String?
  password        String?
  emailVerified   DateTime?
  emailVerifiedAt DateTime?
  image           String?
  role            String     @default("user")
  status          UserStatus @default(ACTIVE)
  trustLevel      TrustLevel @default(GUEST)
  phoneNumber     String?
  phoneVerified   Boolean    @default(false)
  lastActiveAt    DateTime?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  // Relations
  accounts              Account[]
  sessions              Session[]
  userSessions          UserSession[]
  wallets               Wallet[]
  profile               UserProfile?
  addresses             UserAddress[]
  passwordHistory       PasswordHistory[]
  securityLogs          SecurityLog[]
  passwordResetToken    PasswordResetToken?
  twoFactorAuth         TwoFactorAuth?
  backupCodes           BackupCode[]
  trustedDevices        TrustedDevice[]
  apiKeys               ApiKey[]
  calendarEvents        ClientCalendar[]
  notificationPrefs     NotificationPreferences?
  ownedOrganizations    Organization[]         @relation("OrgOwner")
  memberships           OrganizationMember[]
  freezes               AccountFreeze[]
  deletionRequest       AccountDeletion?
  bans                  UserBan[]
  connectedAccounts     ConnectedAccount[]
  bansIssued            UserBan[]              @relation("BannedByUser")
  bansLifted            UserBan[]              @relation("UnbannedByUser")
  emailLogs             EmailLog[]

  @@index([email])
  @@index([status])
  @@index([createdAt])
  @@index([lastActiveAt])
}

model UserProfile {
  id                  String    @id @default(cuid())
  userId              String    @unique
  firstName           String?
  lastName            String?
  avatar              String?
  bio                 String?
  position            String?
  birthDate           DateTime?
  birthMonth          Int?      // 1-12 for birthday celebrations
  birthDay            Int?      // 1-31 for birthday celebrations
  birthDateChangedAt  DateTime? // Max 1 change per year
  birthDateVisibility String    @default("private") // private, friends, public
  language            String    @default("tr")
  currency            String    @default("EUR")
  timezone            String    @default("Europe/Istanbul")
  dateFormat          String    @default("DD/MM/YYYY")
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model UserAddress {
  id         String      @id @default(cuid())
  userId     String
  type       AddressType @default(HOME)
  label      String?     // Custom label like "Office", "Home"
  title      String?
  line1      String
  line2      String?
  city       String
  state      String?
  country    String
  postalCode String?
  isDefault  Boolean     @default(false)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model PasswordHistory {
  id           String   @id @default(cuid())
  userId       String
  passwordHash String
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model LoginAttempt {
  id         String   @id @default(cuid())
  email      String
  ipAddress  String?
  userAgent  String?
  success    Boolean
  failReason String?
  platform   Platform @default(HYBLE)
  createdAt  DateTime @default(now())

  @@index([email])
  @@index([ipAddress])
  @@index([createdAt])
  @@index([email, createdAt])
  @@index([ipAddress, createdAt])
}

model SecurityLog {
  id        String         @id @default(cuid())
  userId    String
  action    SecurityAction
  ipAddress String?
  userAgent String?
  device    String?
  location  String?
  platform  Platform       @default(HYBLE)
  status    SecurityStatus
  metadata  Json?
  createdAt DateTime       @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@index([userId, createdAt])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

enum DeviceType {
  DESKTOP
  MOBILE
  TABLET
  UNKNOWN
}

model UserSession {
  id             String     @id @default(cuid())
  userId         String
  sessionToken   String     @unique
  deviceName     String?
  deviceType     DeviceType @default(UNKNOWN)
  browser        String?
  browserVersion String?
  os             String?
  osVersion      String?
  ipAddress      String?
  location       String?
  platform       Platform   @default(HYBLE)
  lastActiveAt   DateTime   @default(now())
  createdAt      DateTime   @default(now())
  expiresAt      DateTime
  isRevoked      Boolean    @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionToken])
  @@index([lastActiveAt])
}

model Wallet {
  id           String   @id @default(cuid())
  userId       String
  balance      Decimal  @default(0) @db.Decimal(18, 2) // Toplam bakiye (main + bonus + promo)
  mainBalance  Decimal  @default(0) @db.Decimal(18, 2) // Ana bakiye (para yükleme ile)
  bonusBalance Decimal  @default(0) @db.Decimal(18, 2) // Bonus bakiye (kampanyalar)
  promoBalance Decimal  @default(0) @db.Decimal(18, 2) // Promo bakiye (ilk kayıt bonusu vb.)
  currency     String   @default("EUR")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@unique([userId, currency])
  @@index([userId])
}

// ==================== BILLING ====================

enum TransactionType {
  DEPOSIT          // Para yükleme
  CHARGE           // Hizmet ücreti
  REFUND           // İade
  ADJUSTMENT       // Manuel düzeltme
  BONUS            // Bonus/Promosyon
}

enum TransactionStatus {
  PENDING          // İşlem bekliyor
  COMPLETED        // Tamamlandı
  FAILED           // Başarısız
  CANCELLED        // İptal edildi
  REFUNDED         // İade edildi
}

enum PaymentMethod {
  STRIPE           // Stripe ödeme
  PAYTR            // PayTR ödeme
  PAPARA           // Papara ödeme
  BANK_TRANSFER    // Banka havalesi
  WALLET           // Cüzdan ödemesi
  MANUAL           // Manuel (admin)
  SYSTEM           // Sistem otomatik
}

// Bakiye türü - harcama önceliği için
enum BalanceType {
  MAIN             // Ana bakiye
  BONUS            // Bonus bakiye
  PROMO            // Promosyon bakiye
}

model Transaction {
  id              String            @id @default(cuid())
  walletId        String
  type            TransactionType
  status          TransactionStatus @default(PENDING)
  amount          Decimal           @db.Decimal(18, 2)
  balanceBefore   Decimal           @db.Decimal(18, 2)
  balanceAfter    Decimal           @db.Decimal(18, 2)
  currency        String            @default("EUR")
  description     String
  reference       String?           // Stripe payment intent ID veya fatura no
  paymentMethod   PaymentMethod?
  balanceType     BalanceType?      // Hangi bakiye türünden düşüldü
  metadata        Json?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  wallet  Wallet   @relation(fields: [walletId], references: [id], onDelete: Cascade)
  invoice Invoice?

  @@index([walletId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@index([reference])
}

enum InvoiceStatus {
  DRAFT            // Taslak
  PENDING          // Ödeme bekliyor
  PAID             // Ödendi
  OVERDUE          // Gecikmiş
  CANCELLED        // İptal edildi
  REFUNDED         // İade edildi
}

model Invoice {
  id              String        @id @default(cuid())
  transactionId   String?       @unique
  invoiceNumber   String        @unique
  userId          String
  organizationId  String?
  status          InvoiceStatus @default(DRAFT)
  subtotal        Decimal       @db.Decimal(18, 2)
  taxRate         Decimal       @default(0) @db.Decimal(5, 2)
  taxAmount       Decimal       @default(0) @db.Decimal(18, 2)
  total           Decimal       @db.Decimal(18, 2)
  currency        String        @default("EUR")
  dueDate         DateTime?
  paidAt          DateTime?
  notes           String?
  billingAddress  Json?         // Snapshot of billing address at time of invoice
  items           Json          // Array of line items
  metadata        Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  transaction Transaction? @relation(fields: [transactionId], references: [id])

  @@index([userId])
  @@index([organizationId])
  @@index([status])
  @@index([createdAt])
  @@index([invoiceNumber])
}

model StripeCustomer {
  id               String   @id @default(cuid())
  userId           String   @unique
  stripeCustomerId String   @unique
  defaultPaymentMethod String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([stripeCustomerId])
}

model VerificationToken {
  id         String   @id @default(cuid())
  identifier String
  token      String   @unique
  type       String   @default("email")
  expires    DateTime
  createdAt  DateTime @default(now())

  @@unique([identifier, token])
  @@index([identifier])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String   @unique
  expires   DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model TwoFactorAuth {
  id        String   @id @default(cuid())
  userId    String   @unique
  secret    String
  enabled   Boolean  @default(false)
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model BackupCode {
  id        String    @id @default(cuid())
  userId    String
  code      String
  used      Boolean   @default(false)
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ==================== ORGANIZATION ====================

model Organization {
  id          String    @id @default(cuid())
  ownerId     String
  name        String
  slug        String    @unique
  logo        String?
  description String?
  website     String?

  // Business info
  taxId         String?
  vatNumber     String?
  vatVerified   Boolean   @default(false)
  vatVerifiedAt DateTime?
  foundingDate  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  owner          User                 @relation("OrgOwner", fields: [ownerId], references: [id])
  members        OrganizationMember[]
  invites        OrganizationInvite[]
  domains        OrganizationDomain[]
  apiKeys        ApiKey[]
  ssoConfig      SsoConfiguration?
  calendarEvents ClientCalendar[]

  @@index([slug])
  @@index([ownerId])
}

model OrganizationMember {
  id             String           @id @default(cuid())
  organizationId String
  userId         String
  role           OrganizationRole @default(MEMBER)
  invitedBy      String?
  joinedAt       DateTime         @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
}

model OrganizationInvite {
  id             String           @id @default(cuid())
  organizationId String
  email          String
  role           OrganizationRole @default(MEMBER)
  status         InviteStatus     @default(PENDING)
  invitedBy      String
  token          String           @unique @default(cuid())
  expiresAt      DateTime
  acceptedAt     DateTime?
  createdAt      DateTime         @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, email])
  @@index([organizationId])
  @@index([email])
  @@index([token])
}

model OrganizationDomain {
  id                String    @id @default(cuid())
  organizationId    String
  domain            String    @unique
  verified          Boolean   @default(false)
  verificationToken String
  verifiedAt        DateTime?
  createdAt         DateTime  @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

// ==================== TRUSTED DEVICES ====================

model TrustedDevice {
  id          String   @id @default(cuid())
  userId      String
  fingerprint String
  name        String   // "Windows 10 - Chrome"
  lastUsed    DateTime @default(now())
  expiresAt   DateTime
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, fingerprint])
  @@index([userId])
}

// ==================== API KEYS ====================

model ApiKey {
  id                 String    @id @default(cuid())
  userId             String?
  organizationId     String?
  name               String
  keyHash            String    @unique
  keyPrefix          String    // First 8 chars for identification
  scopes             String[]
  ipWhitelist        String[]
  allowedIps         String[]
  allowedOrigins     String[]
  rateLimitPerMinute Int       @default(60)
  rateLimitPerDay    Int       @default(10000)
  lastUsed           DateTime?
  lastUsedAt         DateTime?
  expiresAt          DateTime?
  revokedAt          DateTime?
  createdAt          DateTime  @default(now())

  user         User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  usageLogs    ApiKeyUsage[]

  @@index([keyHash])
  @@index([userId])
  @@index([organizationId])
  @@index([revokedAt])
}

model ApiKeyUsage {
  id           String   @id @default(cuid())
  apiKeyId     String
  endpoint     String
  method       String
  ipAddress    String?
  statusCode   Int
  responseTime Int?     // Response time in milliseconds
  createdAt    DateTime @default(now())

  apiKey ApiKey @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)

  @@index([apiKeyId, createdAt])
}

// ==================== SSO CONFIGURATION ====================

model SsoConfiguration {
  id             String           @id @default(cuid())
  organizationId String           @unique
  provider       String           // okta, azure_ad, google, onelogin, custom_saml
  metadataUrl    String?
  metadataXml    String?          @db.Text
  entityId       String?
  ssoUrl         String?
  certificate    String?          @db.Text
  attributeMapping Json?
  defaultRole    OrganizationRole @default(MEMBER)
  jitProvisioning Boolean         @default(true)
  enabled        Boolean          @default(false)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

// ==================== APPRECIATION PROGRAM ====================

model ClientCalendar {
  id                 String            @id @default(cuid())
  userId             String?
  organizationId     String?
  eventType          CalendarEventType
  eventDate          DateTime
  lastCelebratedYear Int?
  celebrationCount   Int               @default(0)
  createdAt          DateTime          @default(now())

  user         User?            @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization?    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  celebrations CelebrationLog[]

  @@unique([userId, eventType])
  @@unique([organizationId, eventType])
  @@index([eventDate])
}

model CelebrationLog {
  id            String    @id @default(cuid())
  calendarId    String
  userId        String?   // For quick lookup
  year          Int
  type          String    // email, panel_notification, coupon
  emailSentAt   DateTime?
  emailOpenedAt DateTime?
  couponCode    String?
  couponUsed    Boolean   @default(false)
  couponUsedAt  DateTime?
  createdAt     DateTime  @default(now())

  calendar ClientCalendar @relation(fields: [calendarId], references: [id], onDelete: Cascade)

  @@index([calendarId])
  @@index([userId, year])
}

// ==================== ACCOUNT MANAGEMENT ====================

model AccountFreeze {
  id         String    @id @default(cuid())
  userId     String
  reason     String    // vacation, security, other
  note       String?
  frozenAt   DateTime  @default(now())
  unfrozenAt DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model AccountDeletion {
  id          String                @id @default(cuid())
  userId      String                @unique
  status      AccountDeletionStatus @default(PENDING)
  requestedAt DateTime              @default(now())
  scheduledAt DateTime              // 14 days from request
  cancelledAt DateTime?
  completedAt DateTime?
  reason      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([scheduledAt])
}

// ==================== ADMIN ====================

model AdminAction {
  id           String   @id @default(cuid())
  adminId      String
  targetUserId String?
  targetOrgId  String?
  action       String   // ban, unban, impersonate, verify, etc.
  reason       String?
  evidence     String?
  details      Json?
  createdAt    DateTime @default(now())

  @@index([adminId])
  @@index([targetUserId])
  @@index([createdAt])
}

model UserBan {
  id           String    @id @default(cuid())
  userId       String
  type         BanType
  reason       String
  evidence     String?
  bannedBy     String
  active       Boolean   @default(true)
  expiresAt    DateTime? // null for permanent
  liftedAt     DateTime?
  liftedBy     String?
  unbannedAt   DateTime?
  unbannedById String?
  createdAt    DateTime  @default(now())

  user       User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  bannedByUser   User? @relation("BannedByUser", fields: [bannedBy], references: [id])
  unbannedByUser User? @relation("UnbannedByUser", fields: [unbannedById], references: [id])

  @@index([userId])
  @@index([expiresAt])
  @@index([active])
}

// ==================== NOTIFICATIONS ====================

model NotificationPreferences {
  id     String @id @default(cuid())
  userId String @unique

  // Can't be turned off (always true)
  securityEmail Boolean @default(true)
  securityPanel Boolean @default(true)

  // Default on
  billingEmail  Boolean @default(true)
  billingPanel  Boolean @default(true)
  projectsEmail Boolean @default(true)
  projectsPanel Boolean @default(true)
  supportEmail  Boolean @default(true)
  supportPanel  Boolean @default(true)

  // Default off
  updatesEmail   Boolean @default(false)
  updatesPanel   Boolean @default(false)
  marketingEmail Boolean @default(false)
  marketingPanel Boolean @default(false)

  // Discord
  discordDm Boolean @default(false)

  // Appreciation
  appreciationEmail Boolean @default(true)

  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ==================== CONNECTED ACCOUNTS ====================

model ConnectedAccount {
  id                String   @id @default(cuid())
  userId            String
  provider          String   // google, github, discord, etc.
  providerAccountId String
  email             String?
  name              String?
  avatar            String?
  accessToken       String?  @db.Text
  refreshToken      String?  @db.Text
  expiresAt         DateTime?
  connectedAt       DateTime @default(now())
  lastUsedAt        DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@index([provider])
}

// ==================== EMAIL LOGS ====================

enum EmailStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
  BOUNCED
  COMPLAINED
  OPENED
  CLICKED
}

enum EmailType {
  VERIFICATION
  RESET_PASSWORD
  WELCOME
  INVOICE
  TICKET_REPLY
  ORG_INVITE
  SECURITY_ALERT
  MARKETING
  SYSTEM_ALERT
}

model EmailLog {
  id           String      @id @default(cuid())
  userId       String?
  resendId     String?     // Resend tarafından dönen ID
  type         EmailType
  recipient    String      // Statik email (user.email değişirse log bozulmasın)
  subject      String
  status       EmailStatus @default(PENDING)
  error        String?     // Hata mesajı varsa
  metadata     Json?       // Ek bilgiler (template data vb.)
  openedAt     DateTime?
  clickedAt    DateTime?
  deliveredAt  DateTime?
  bouncedAt    DateTime?
  complainedAt DateTime?
  sentAt       DateTime    @default(now())
  createdAt    DateTime    @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([resendId])
  @@index([recipient])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

// ==================== FAZ2-PIM: PRODUCT INFORMATION MANAGEMENT ====================

enum ProductType {
  DIGITAL       // Dijital ürün (tema, SDK, dosya)
  SUBSCRIPTION  // Abonelik bazlı hizmet
  BUNDLE        // Paket ürün
  SERVICE       // Tek seferlik hizmet
}

enum ProductStatus {
  DRAFT         // Taslak (yayında değil)
  ACTIVE        // Aktif (satışta)
  ARCHIVED      // Arşivlenmiş (satışta değil)
}

enum StockType {
  UNLIMITED     // Sınırsız stok (dijital ürünler)
  LIMITED       // Sınırlı stok
  CAPACITY      // Kapasite bazlı (örn: max 100 kullanıcı)
}

model Category {
  id          String     @id @default(cuid())
  parentId    String?
  parent      Category?  @relation("CategoryTree", fields: [parentId], references: [id], onDelete: SetNull)
  children    Category[] @relation("CategoryTree")

  nameTr      String
  nameEn      String
  slug        String     @unique
  icon        String?    // Lucide icon name
  description String?    @db.Text

  sortOrder   Int        @default(0)
  isActive    Boolean    @default(true)

  products    Product[]

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([parentId])
  @@index([slug])
  @@index([sortOrder])
}

model Product {
  id            String        @id @default(cuid())
  type          ProductType
  status        ProductStatus @default(DRAFT)

  categoryId    String?
  category      Category?     @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  // Temel Bilgiler (i18n - Türkçe/İngilizce)
  nameTr        String
  nameEn        String
  slug          String        @unique
  descriptionTr String?       @db.Text
  descriptionEn String?       @db.Text
  shortDescTr   String?       // Kısa açıklama (liste görünümü için)
  shortDescEn   String?

  // Hedef Kitle ve Etiketler
  targetAudience String[]     // ["startup", "smb", "enterprise"]
  tags           String[]

  // Fiyatlandırma (Varyant yoksa baz fiyat)
  basePrice     Decimal?      @db.Decimal(10, 2)
  currency      String        @default("EUR")
  taxRate       Decimal       @db.Decimal(5, 2) @default(20)

  // Öne Çıkarma
  isFeatured    Boolean       @default(false)
  featuredOrder Int?

  // Relations
  variants      ProductVariant[]
  media         ProductMedia[]
  meta          ProductMeta?
  relations     ProductRelation[] @relation("SourceProduct")
  relatedTo     ProductRelation[] @relation("RelatedProduct")

  // Bundle için
  bundleItems   BundleItem[]  @relation("BundleProduct")
  includedIn    BundleItem[]  @relation("IncludedProduct")

  // Audit
  createdBy     String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([categoryId])
  @@index([status])
  @@index([type])
  @@index([slug])
  @@index([isFeatured])
}

model ProductVariant {
  id            String    @id @default(cuid())
  productId     String
  product       Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  sku           String    @unique
  name          String    // "Starter", "Business", "Enterprise"

  price         Decimal   @db.Decimal(10, 2)
  currency      String    @default("EUR")

  // Özellik matrisi (JSON) - örn: { "ram": "4GB", "disk": "50GB", "ssl": true }
  features      Json?

  // Stok Yönetimi
  stockType     StockType @default(UNLIMITED)
  stockQty      Int?      // LIMITED için mevcut stok
  reservedQty   Int       @default(0) // Sepette bekleyen

  // Abonelik için
  billingPeriod String?   // monthly, quarterly, annually

  // Sıralama ve Varsayılan
  sortOrder     Int       @default(0)
  isDefault     Boolean   @default(false)
  isActive      Boolean   @default(true)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([productId])
  @@index([sku])
  @@index([isActive])
}

model ProductMedia {
  id          String   @id @default(cuid())
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  type        String   // image, video, thumbnail, banner, icon
  url         String   // R2 URL veya external URL
  alt         String?  // SEO için alt text
  title       String?  // Hover title

  width       Int?     // Görsel boyutları
  height      Int?
  fileSize    Int?     // Byte cinsinden

  sortOrder   Int      @default(0)
  isPrimary   Boolean  @default(false)

  createdAt   DateTime @default(now())

  @@index([productId])
  @@index([type])
  @@index([sortOrder])
}

model ProductMeta {
  id            String  @id @default(cuid())
  productId     String  @unique
  product       Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // SEO Meta Tags (i18n)
  metaTitleTr   String?
  metaTitleEn   String?
  metaDescTr    String?
  metaDescEn    String?

  // Open Graph
  ogImage       String?

  // Schema.org Product (JSON-LD)
  schemaJson    Json?

  // Canonical URL (duplicate content önlemi)
  canonicalUrl  String?

  // Anahtar Kelimeler
  keywordsTr    String[]
  keywordsEn    String[]
}

model ProductRelation {
  id          String  @id @default(cuid())

  productId   String
  product     Product @relation("SourceProduct", fields: [productId], references: [id], onDelete: Cascade)

  relatedId   String
  relatedProduct Product @relation("RelatedProduct", fields: [relatedId], references: [id], onDelete: Cascade)

  type        String  // upsell, crosssell, accessory, similar

  sortOrder   Int     @default(0)

  @@unique([productId, relatedId, type])
  @@index([productId])
  @@index([relatedId])
}

model BundleItem {
  id                String  @id @default(cuid())

  bundleProductId   String
  bundleProduct     Product @relation("BundleProduct", fields: [bundleProductId], references: [id], onDelete: Cascade)

  includedProductId String
  includedProduct   Product @relation("IncludedProduct", fields: [includedProductId], references: [id], onDelete: Restrict)

  quantity          Int     @default(1)
  individualValue   Decimal @db.Decimal(10, 2) // Bireysel değer (tasarruf hesabı için)

  sortOrder         Int     @default(0)

  @@unique([bundleProductId, includedProductId])
  @@index([bundleProductId])
}

// ==================== FAZ3: CART & ORDER SYSTEM ====================

enum CartStatus {
  ACTIVE        // Aktif sepet
  CHECKOUT      // Ödeme aşamasında
  CONVERTED     // Siparişe dönüştürüldü
  ABANDONED     // Terk edilmiş
}

model Cart {
  id            String      @id @default(cuid())
  userId        String?
  sessionId     String?     // Guest kullanıcılar için
  status        CartStatus  @default(ACTIVE)

  // Kupon
  couponId      String?
  coupon        Coupon?     @relation(fields: [couponId], references: [id], onDelete: SetNull)
  couponCode    String?
  discountAmount Decimal    @default(0) @db.Decimal(10, 2)

  // Totals (cache, checkout anında hesaplanır)
  subtotal      Decimal     @default(0) @db.Decimal(10, 2)
  taxAmount     Decimal     @default(0) @db.Decimal(10, 2)
  total         Decimal     @default(0) @db.Decimal(10, 2)
  currency      String      @default("EUR")

  // Meta
  ipAddress     String?
  userAgent     String?

  expiresAt     DateTime?   // Guest sepetler için son kullanma
  convertedAt   DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  items         CartItem[]
  order         Order?

  @@unique([userId, status]) // Kullanıcı başına sadece 1 aktif sepet
  @@index([sessionId])
  @@index([status])
  @@index([expiresAt])
}

model CartItem {
  id            String    @id @default(cuid())
  cartId        String
  cart          Cart      @relation(fields: [cartId], references: [id], onDelete: Cascade)

  productId     String
  variantId     String?   // ProductVariant ID (varsa)
  quantity      Int       @default(1)

  // Snapshot (sepete eklendiğindeki fiyat)
  unitPrice     Decimal   @db.Decimal(10, 2)
  currency      String    @default("EUR")

  // Ürün bilgileri snapshot
  productName   String
  variantName   String?
  productSlug   String

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([cartId, productId, variantId])
  @@index([cartId])
}

enum OrderStatus {
  PENDING         // Ödeme bekleniyor
  PROCESSING      // İşleniyor
  COMPLETED       // Tamamlandı
  FAILED          // Başarısız
  CANCELLED       // İptal edildi
  REFUNDED        // İade edildi
  PARTIALLY_REFUNDED // Kısmi iade
}

enum PaymentStatus {
  PENDING         // Ödeme bekleniyor
  AUTHORIZED      // Yetkilendirildi
  CAPTURED        // Çekildi
  FAILED          // Başarısız
  REFUNDED        // İade edildi
  PARTIALLY_REFUNDED // Kısmi iade
}

model Order {
  id              String        @id @default(cuid())
  orderNumber     String        @unique // HYB-20250101-XXXX
  userId          String
  cartId          String?       @unique

  status          OrderStatus   @default(PENDING)
  paymentStatus   PaymentStatus @default(PENDING)

  // Finansallar
  subtotal        Decimal       @db.Decimal(10, 2)
  discountAmount  Decimal       @default(0) @db.Decimal(10, 2)
  taxRate         Decimal       @default(20) @db.Decimal(5, 2)
  taxAmount       Decimal       @db.Decimal(10, 2)
  total           Decimal       @db.Decimal(10, 2)
  currency        String        @default("EUR")

  // Ödeme bilgileri
  paymentMethod   String?       // wallet, stripe, bank_transfer
  paymentRef      String?       // Stripe PaymentIntent ID veya referans
  walletAmount    Decimal       @default(0) @db.Decimal(10, 2) // Cüzdandan ödenen
  cardAmount      Decimal       @default(0) @db.Decimal(10, 2) // Karttan ödenen

  // Kupon
  couponId        String?
  couponCode      String?

  // Fatura
  invoiceId       String?

  // Billing Address (snapshot)
  billingAddress  Json?

  // Meta
  notes           String?
  ipAddress       String?
  userAgent       String?

  paidAt          DateTime?
  completedAt     DateTime?
  cancelledAt     DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  cart            Cart?         @relation(fields: [cartId], references: [id])
  items           OrderItem[]
  subscriptions   Subscription[]

  @@index([userId])
  @@index([status])
  @@index([paymentStatus])
  @@index([orderNumber])
  @@index([createdAt])
}

model OrderItem {
  id            String    @id @default(cuid())
  orderId       String
  order         Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId     String
  variantId     String?
  quantity      Int

  // Snapshot
  unitPrice     Decimal   @db.Decimal(10, 2)
  totalPrice    Decimal   @db.Decimal(10, 2)
  currency      String    @default("EUR")

  productName   String
  variantName   String?
  productSlug   String

  // Subscription products
  isSubscription Boolean  @default(false)
  billingPeriod  String?  // monthly, quarterly, annually

  createdAt     DateTime  @default(now())

  @@index([orderId])
  @@index([productId])
}

// ==================== FAZ3: SUBSCRIPTION SYSTEM ====================

enum SubscriptionStatus {
  TRIAL           // Deneme süresi
  ACTIVE          // Aktif
  PAST_DUE        // Ödeme gecikmiş
  PAUSED          // Duraklatılmış
  CANCELLED       // İptal edilmiş
  EXPIRED         // Süresi dolmuş
}

model Subscription {
  id                String             @id @default(cuid())
  userId            String
  orderId           String?
  order             Order?             @relation(fields: [orderId], references: [id])

  productId         String
  variantId         String?

  status            SubscriptionStatus @default(ACTIVE)

  // Periyot
  billingPeriod     String             // monthly, quarterly, annually
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime

  // Fiyatlandırma
  price             Decimal            @db.Decimal(10, 2)
  currency          String             @default("EUR")

  // Trial
  trialStart        DateTime?
  trialEnd          DateTime?

  // Auto-renewal
  autoRenew         Boolean            @default(true)
  cancelAtPeriodEnd Boolean            @default(false)

  // External refs
  stripeSubscriptionId String?

  // Snapshot
  productName       String
  variantName       String?

  cancelledAt       DateTime?
  cancelReason      String?
  pausedAt          DateTime?
  pauseReason       String?
  resumesAt         DateTime?

  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  @@index([userId])
  @@index([status])
  @@index([currentPeriodEnd])
  @@index([stripeSubscriptionId])
}

// ==================== FAZ3: VOUCHER/COUPON SYSTEM ====================

enum CouponType {
  PERCENTAGE      // Yüzde indirim
  FIXED           // Sabit tutar
  FREE_SHIPPING   // Ücretsiz kargo (gelecek için)
}

enum CouponStatus {
  ACTIVE          // Aktif
  INACTIVE        // Pasif
  EXPIRED         // Süresi dolmuş
  DEPLETED        // Kullanım limiti dolmuş
}

model Coupon {
  id              String        @id @default(cuid())
  code            String        @unique
  description     String?

  type            CouponType
  status          CouponStatus  @default(ACTIVE)

  // Değer
  value           Decimal       @db.Decimal(10, 2) // Yüzde veya sabit tutar
  minOrderAmount  Decimal?      @db.Decimal(10, 2) // Minimum sipariş tutarı
  maxDiscount     Decimal?      @db.Decimal(10, 2) // Max indirim (yüzde için)

  // Kullanım limitleri
  usageLimit      Int?          // Toplam kullanım limiti
  usagePerUser    Int           @default(1) // Kullanıcı başına limit
  usedCount       Int           @default(0) // Toplam kullanılma sayısı

  // Geçerlilik
  startsAt        DateTime      @default(now())
  expiresAt       DateTime?

  // Kısıtlamalar
  productIds      String[]      // Sadece belirli ürünler için
  categoryIds     String[]      // Sadece belirli kategoriler için
  excludeProductIds String[]    // Hariç tutulan ürünler
  userIds         String[]      // Sadece belirli kullanıcılar için

  // Referans
  createdBy       String?
  campaign        String?       // Kampanya adı/ID

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  usages          CouponUsage[]
  carts           Cart[]

  @@index([code])
  @@index([status])
  @@index([expiresAt])
}

model CouponUsage {
  id          String    @id @default(cuid())
  couponId    String
  coupon      Coupon    @relation(fields: [couponId], references: [id], onDelete: Cascade)

  userId      String
  orderId     String?

  discountAmount Decimal @db.Decimal(10, 2)

  usedAt      DateTime  @default(now())

  @@unique([couponId, userId, orderId])
  @@index([couponId])
  @@index([userId])
}

// ==================== FAZ3: VOUCHER/GIFT CARDS ====================

enum VoucherType {
  GIFT_CARD       // Hediye kartı (bakiye yükler)
  PROMO_CREDIT    // Promosyon kredisi
  REFERRAL        // Referans bonusu
  BIRTHDAY        // Doğum günü hediyesi
}

enum VoucherStatus {
  ACTIVE          // Kullanılabilir
  USED            // Kullanılmış
  EXPIRED         // Süresi dolmuş
  CANCELLED       // İptal edilmiş
}

model Voucher {
  id            String        @id @default(cuid())
  code          String        @unique
  type          VoucherType
  status        VoucherStatus @default(ACTIVE)

  // Değer
  originalAmount Decimal      @db.Decimal(10, 2)
  remainingAmount Decimal     @db.Decimal(10, 2)
  currency      String        @default("EUR")

  // Kısıtlamalar
  userId        String?       // Belirli kullanıcıya özel
  minOrderAmount Decimal?     @db.Decimal(10, 2)

  // Geçerlilik
  expiresAt     DateTime?

  // Referans
  createdBy     String?
  reason        String?

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  redemptions   VoucherRedemption[]

  @@index([code])
  @@index([userId])
  @@index([status])
  @@index([expiresAt])
}

model VoucherRedemption {
  id          String    @id @default(cuid())
  voucherId   String
  voucher     Voucher   @relation(fields: [voucherId], references: [id], onDelete: Cascade)

  userId      String
  amount      Decimal   @db.Decimal(10, 2)
  type        String    // wallet_deposit, order_payment

  balanceBefore Decimal @db.Decimal(10, 2)
  balanceAfter  Decimal @db.Decimal(10, 2)

  redeemedAt  DateTime  @default(now())

  @@index([voucherId])
  @@index([userId])
}

// ==================== FAZ3: IN-APP NOTIFICATIONS ====================

enum NotificationType {
  SYSTEM          // Sistem bildirimi
  SECURITY        // Güvenlik uyarısı
  BILLING         // Fatura/Ödeme
  ORDER           // Sipariş durumu
  SUBSCRIPTION    // Abonelik bildirimi
  SUPPORT         // Destek talebi
  MARKETING       // Pazarlama
  ANNOUNCEMENT    // Duyuru
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

model Notification {
  id            String               @id @default(cuid())
  userId        String

  type          NotificationType
  priority      NotificationPriority @default(NORMAL)

  title         String
  message       String               @db.Text

  // Link/Action
  actionUrl     String?
  actionLabel   String?

  // Meta
  icon          String?              // Lucide icon name
  metadata      Json?

  // Status
  isRead        Boolean              @default(false)
  readAt        DateTime?
  isDismissed   Boolean              @default(false)
  dismissedAt   DateTime?

  // Expiry
  expiresAt     DateTime?

  createdAt     DateTime             @default(now())

  @@index([userId])
  @@index([isRead])
  @@index([type])
  @@index([createdAt])
  @@index([userId, isRead])
}

// ==================== FAZ3: SUPPORT TICKET SYSTEM ====================

enum TicketStatus {
  OPEN            // Açık
  AWAITING_REPLY  // Yanıt bekleniyor (müşteri)
  IN_PROGRESS     // İşleniyor
  ON_HOLD         // Beklemede
  RESOLVED        // Çözüldü
  CLOSED          // Kapatıldı
}

enum TicketPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum TicketCategory {
  BILLING         // Fatura/Ödeme
  TECHNICAL       // Teknik destek
  ACCOUNT         // Hesap sorunları
  SALES           // Satış öncesi
  FEEDBACK        // Geri bildirim
  BUG_REPORT      // Hata raporu
  FEATURE_REQUEST // Özellik talebi
  OTHER           // Diğer
}

model Ticket {
  id              String          @id @default(cuid())
  referenceNo     String          @unique // TKT-20250101-XXXX

  userId          String
  organizationId  String?

  subject         String
  category        TicketCategory
  status          TicketStatus    @default(OPEN)
  priority        TicketPriority  @default(NORMAL)

  // Assignment
  assignedTo      String?         // Admin user ID
  assignedAt      DateTime?

  // Related resources
  relatedOrderId  String?
  relatedProductId String?
  relatedSubscriptionId String?

  // Tags/Labels
  tags            String[]

  // Meta
  metadata        Json?
  ipAddress       String?
  userAgent       String?

  // SLA
  firstResponseAt DateTime?
  resolvedAt      DateTime?
  closedAt        DateTime?

  // Rating (after resolution)
  rating          Int?            // 1-5
  ratingComment   String?
  ratedAt         DateTime?

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  messages        TicketMessage[]
  attachments     TicketAttachment[]

  @@index([userId])
  @@index([organizationId])
  @@index([status])
  @@index([assignedTo])
  @@index([referenceNo])
  @@index([category])
  @@index([createdAt])
}

model TicketMessage {
  id            String    @id @default(cuid())
  ticketId      String
  ticket        Ticket    @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  authorId      String    // User or Admin ID
  authorType    String    // user, admin, system
  authorName    String?   // Snapshot

  content       String    @db.Text

  // Internal note (only visible to admins)
  isInternal    Boolean   @default(false)

  // Auto-reply indicator
  isAutoReply   Boolean   @default(false)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  attachments   TicketAttachment[]

  @@index([ticketId])
  @@index([authorId])
  @@index([createdAt])
}

model TicketAttachment {
  id            String    @id @default(cuid())
  ticketId      String
  ticket        Ticket    @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  messageId     String?
  message       TicketMessage? @relation(fields: [messageId], references: [id], onDelete: SetNull)

  fileName      String
  fileSize      Int
  fileType      String
  fileUrl       String

  uploadedBy    String
  uploadedAt    DateTime  @default(now())

  @@index([ticketId])
  @@index([messageId])
}

// ==================== FAZ3: STATUS PAGE ====================

enum ServiceCategory {
  CORE            // Core services
  CLOUD           // Cloud hosting
  GAMING          // Game servers
  API             // API services
  BILLING         // Payment/Billing
  AUTH            // Authentication
}

enum ServiceHealthStatus {
  OPERATIONAL     // Çalışıyor
  DEGRADED        // Performans düşük
  PARTIAL_OUTAGE  // Kısmi kesinti
  MAJOR_OUTAGE    // Büyük kesinti
  MAINTENANCE     // Bakım
}

model ServiceStatus {
  id              String              @id @default(cuid())

  name            String              // "API Gateway", "Database", etc.
  slug            String              @unique
  description     String?
  category        ServiceCategory

  status          ServiceHealthStatus @default(OPERATIONAL)
  statusMessage   String?

  // Uptime tracking
  uptimePercent   Decimal             @default(100) @db.Decimal(5, 2)
  lastCheckedAt   DateTime            @default(now())
  lastIncidentAt  DateTime?

  // Display
  isPublic        Boolean             @default(true)
  sortOrder       Int                 @default(0)

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  incidents       Incident[]

  @@index([status])
  @@index([category])
  @@index([isPublic])
}

enum IncidentStatus {
  INVESTIGATING   // Araştırılıyor
  IDENTIFIED      // Tespit edildi
  MONITORING      // İzleniyor
  RESOLVED        // Çözüldü
}

enum IncidentImpact {
  NONE            // Etki yok
  MINOR           // Küçük etki
  MAJOR           // Büyük etki
  CRITICAL        // Kritik
}

model Incident {
  id              String          @id @default(cuid())

  title           String
  status          IncidentStatus  @default(INVESTIGATING)
  impact          IncidentImpact  @default(MINOR)

  // Affected services
  serviceIds      String[]
  services        ServiceStatus[] @relation

  // Timeline
  startedAt       DateTime        @default(now())
  resolvedAt      DateTime?

  // Investigation
  rootCause       String?         @db.Text
  resolution      String?         @db.Text

  // Postmortem
  postmortemUrl   String?

  // Visibility
  isPublic        Boolean         @default(true)

  createdBy       String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  updates         IncidentUpdate[]

  @@index([status])
  @@index([startedAt])
  @@index([isPublic])
}

model IncidentUpdate {
  id            String    @id @default(cuid())
  incidentId    String
  incident      Incident  @relation(fields: [incidentId], references: [id], onDelete: Cascade)

  status        IncidentStatus
  message       String    @db.Text

  createdBy     String?
  createdAt     DateTime  @default(now())

  @@index([incidentId])
  @@index([createdAt])
}

// ==================== FAZ3: SCHEDULED MAINTENANCE ====================

model ScheduledMaintenance {
  id              String          @id @default(cuid())

  title           String
  description     String          @db.Text

  // Affected services
  serviceIds      String[]

  // Schedule
  scheduledStart  DateTime
  scheduledEnd    DateTime

  // Actual times
  actualStart     DateTime?
  actualEnd       DateTime?

  // Status
  isCancelled     Boolean         @default(false)
  cancelReason    String?

  // Notifications sent
  notificationSentAt DateTime?
  reminderSentAt    DateTime?

  createdBy       String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([scheduledStart])
  @@index([isCancelled])
}

// ==================== FAZ2: DELIVERY SYSTEM ====================

enum DeliveryStatus {
  PENDING         // Teslimat bekleniyor
  PROCESSING      // İşleniyor
  DELIVERED       // Teslim edildi
  FAILED          // Başarısız
  REFUNDED        // İade edildi
}

enum DeliveryType {
  INSTANT         // Anında teslimat (dijital)
  SCHEDULED       // Zamanlanmış teslimat
  MANUAL          // Manuel teslimat
}

model Delivery {
  id              String          @id @default(cuid())

  orderId         String
  orderItemId     String
  userId          String

  type            DeliveryType    @default(INSTANT)
  status          DeliveryStatus  @default(PENDING)

  // Product info snapshot
  productId       String
  productName     String
  variantId       String?
  variantName     String?

  // Delivery content (encrypted if sensitive)
  deliveryData    Json?           // { licenseKey, downloadUrl, accessCredentials, etc. }

  // Access tracking
  accessCount     Int             @default(0)
  maxAccessCount  Int?            // null = unlimited
  accessExpiresAt DateTime?

  // Timestamps
  deliveredAt     DateTime?
  firstAccessedAt DateTime?
  lastAccessedAt  DateTime?

  // Error handling
  failureReason   String?
  retryCount      Int             @default(0)
  maxRetries      Int             @default(3)
  nextRetryAt     DateTime?

  // Meta
  metadata        Json?
  ipAddress       String?

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  accessLogs      DeliveryAccessLog[]

  @@index([orderId])
  @@index([userId])
  @@index([status])
  @@index([productId])
}

model DeliveryAccessLog {
  id            String    @id @default(cuid())
  deliveryId    String
  delivery      Delivery  @relation(fields: [deliveryId], references: [id], onDelete: Cascade)

  userId        String
  ipAddress     String?
  userAgent     String?

  action        String    // view, download, activate

  createdAt     DateTime  @default(now())

  @@index([deliveryId])
  @@index([userId])
  @@index([createdAt])
}

// ==================== FAZ2: PAYMENT GATEWAY RECORDS ====================

enum PaymentGateway {
  STRIPE
  PAYTR
  PAPARA
}

enum PaymentGatewayStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

model PaymentRecord {
  id                String               @id @default(cuid())

  userId            String
  orderId           String?
  walletId          String?

  gateway           PaymentGateway
  status            PaymentGatewayStatus @default(PENDING)

  // Amounts
  amount            Decimal              @db.Decimal(10, 2)
  currency          String               @default("TRY")
  fee               Decimal              @default(0) @db.Decimal(10, 2)
  netAmount         Decimal              @db.Decimal(10, 2)

  // Gateway references
  externalId        String?              // Gateway transaction ID
  externalStatus    String?              // Gateway status

  // PayTR specific
  paytrMerchantOid  String?
  paytrToken        String?

  // Papara specific
  paparaPaymentId   String?
  paparaAccountNumber String?

  // Stripe specific
  stripePaymentIntentId String?
  stripeChargeId        String?

  // Card info (masked)
  cardBrand         String?              // visa, mastercard
  cardLast4         String?
  cardHolderName    String?

  // Error handling
  errorCode         String?
  errorMessage      String?

  // Webhook data
  webhookReceivedAt DateTime?
  webhookData       Json?

  // Refund info
  refundedAmount    Decimal              @default(0) @db.Decimal(10, 2)
  refundedAt        DateTime?
  refundReason      String?

  // Meta
  ipAddress         String?
  userAgent         String?
  metadata          Json?

  completedAt       DateTime?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt

  @@index([userId])
  @@index([orderId])
  @@index([walletId])
  @@index([gateway])
  @@index([status])
  @@index([externalId])
  @@index([paytrMerchantOid])
  @@index([paparaPaymentId])
  @@index([stripePaymentIntentId])
}

// ==================== DIGITAL DELIVERY ====================

enum FileStatus {
  ACTIVE
  INACTIVE
  DELETED
}

model ProductFile {
  id            String      @id @default(cuid())
  productId     String
  variantId     String?

  // File info
  name          String      // Display name
  filename      String      // Original filename
  r2Key         String      @unique // R2 storage key
  r2Url         String      // Public URL (if public) or empty
  contentType   String      // MIME type
  size          Int         // File size in bytes

  // Version control
  version       String      @default("1.0.0")
  changelog     String?     @db.Text

  // Access control
  isPublic      Boolean     @default(false) // Public preview vs private download
  status        FileStatus  @default(ACTIVE)

  // Metadata
  checksum      String?     // MD5 or SHA256 hash for integrity
  metadata      Json?

  // Relations
  downloads     DownloadToken[]

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([productId])
  @@index([variantId])
  @@index([status])
}

model DownloadToken {
  id            String      @id @default(cuid())
  token         String      @unique @default(cuid())

  // Relations
  fileId        String
  file          ProductFile @relation(fields: [fileId], references: [id], onDelete: Cascade)
  userId        String
  orderId       String?     // Which order granted access
  licenseId     String?     // Which license granted access

  // Access control
  maxDownloads  Int         @default(5) // Max download attempts
  downloadCount Int         @default(0)
  expiresAt     DateTime    // Token expiration
  lastUsedAt    DateTime?
  ipAddress     String?     // IP that created/used the token

  // Audit
  createdAt     DateTime    @default(now())

  @@index([userId])
  @@index([fileId])
  @@index([orderId])
  @@index([licenseId])
  @@index([token])
  @@index([expiresAt])
}

// ==================== LICENSE MANAGEMENT ====================

enum LicenseStatus {
  ACTIVE
  SUSPENDED
  EXPIRED
  REVOKED
  PENDING
}

enum LicenseType {
  PERPETUAL     // Lifetime license
  SUBSCRIPTION  // Recurring subscription
  TRIAL         // Trial period
  DEVELOPER     // Developer/testing license
}

model License {
  id            String        @id @default(cuid())
  licenseKey    String        @unique

  // Relations
  userId        String
  productId     String
  variantId     String?
  orderId       String?       // Original purchase order

  // License details
  type          LicenseType   @default(PERPETUAL)
  status        LicenseStatus @default(PENDING)

  // Validity
  activatedAt   DateTime?
  expiresAt     DateTime?
  lastCheckedAt DateTime?

  // Usage limits
  maxActivations Int          @default(1)
  activationCount Int         @default(0)

  // Domain/IP binding
  allowedDomains String[]
  allowedIps     String[]

  // Metadata
  productName   String        // Cached product name
  variantName   String?
  metadata      Json?
  notes         String?       @db.Text

  // Relations
  activations   LicenseActivation[]

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([userId])
  @@index([productId])
  @@index([orderId])
  @@index([status])
  @@index([licenseKey])
  @@index([expiresAt])
}

model LicenseActivation {
  id            String    @id @default(cuid())
  licenseId     String
  license       License   @relation(fields: [licenseId], references: [id], onDelete: Cascade)

  // Device/environment info
  machineId     String?   // Hardware fingerprint
  hostname      String?
  domain        String?
  ipAddress     String
  userAgent     String?

  // Status
  isActive      Boolean   @default(true)
  deactivatedAt DateTime?
  deactivatedBy String?   // userId or "system"
  deactivateReason String?

  // Audit
  createdAt     DateTime  @default(now())

  @@index([licenseId])
  @@index([machineId])
  @@index([isActive])
}
