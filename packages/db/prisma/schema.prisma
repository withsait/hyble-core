generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum UserStatus {
  ACTIVE
  SUSPENDED
  FROZEN
  PENDING_DELETION
}

enum TrustLevel {
  GUEST      // Level 0: Unverified
  VERIFIED   // Level 1: Email verified
  SECURE     // Level 2: 2FA enabled
  CORPORATE  // Level 3: Corporate verified
}

enum Platform {
  HYBLE
  STUDIOS   // Gaming vertical (formerly MINEBLE)
  DIGITAL   // Web services vertical
  CLOUD     // SaaS vertical
}

enum ServiceType {
  GAME_SERVER      // Minecraft, Roblox, Rust etc.
  WEB_PROJECT      // Web hosting, domains
  SAAS_LICENSE     // GamePanel, WebStore licenses
  DIGITAL_PRODUCT  // Digital downloads, templates
}

enum BanScope {
  SERVICE    // Ban only affects specific service
  ECOSYSTEM  // Ban affects entire Hyble ecosystem
}

enum AddressType {
  HOME
  WORK
  BILLING
  SHIPPING
  OTHER
}

enum SecurityAction {
  LOGIN
  LOGOUT
  REGISTER
  PASSWORD_CHANGE
  PASSWORD_RESET_REQUEST
  PASSWORD_RESET
  EMAIL_CHANGE
  EMAIL_VERIFIED
  PHONE_CHANGE
  TWO_FACTOR_ENABLE
  TWO_FACTOR_DISABLE
  TWO_FACTOR_VERIFY
  BACKUP_CODE_USED
  ACCOUNT_LOCK
  ACCOUNT_UNLOCK
  ACCOUNT_FREEZE
  ACCOUNT_UNFREEZE
  ACCOUNT_DELETE_REQUEST
  ACCOUNT_DELETE_CANCEL
  SESSION_REVOKE
  SESSION_REVOKE_ALL
  DEVICE_TRUST
  DEVICE_UNTRUST
  API_KEY_CREATE
  API_KEY_REVOKE
  API_KEY_UPDATE
  API_KEY_REGENERATE
  OAUTH_CONNECT
  OAUTH_DISCONNECT
  ORG_CREATE
  ORG_JOIN
  ORG_LEAVE
  ORG_INVITE_SEND
  ORG_INVITE_ACCEPT
  ORG_MEMBER_ROLE_CHANGE
  ORG_MEMBER_REMOVE
  IMPERSONATION_START
  IMPERSONATION_END
  ACCOUNT_BAN
  ACCOUNT_UNBAN
  ADMIN_IMPERSONATION
  GHOST_ACCOUNT_CLEANUP
}

enum SecurityStatus {
  SUCCESS
  FAILURE
  BLOCKED
}

enum OrganizationRole {
  OWNER
  ADMIN
  MANAGER
  MEMBER
  BILLING
  VIEWER
}

enum InviteStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
  CANCELLED
}

enum BanType {
  TEMPORARY    // Temporary suspension
  PERMANENT    // Permanent termination
  SHADOW       // Shadow ban (user doesn't know)
}

enum CalendarEventType {
  BIRTHDAY
  ANNIVERSARY
  COMPANY_FOUNDING
  PARTNERSHIP_ANNIVERSARY
}

enum AccountDeletionStatus {
  PENDING
  PROCESSING
  COMPLETED
  CANCELLED
}

// ==================== USER ====================

model User {
  id              String     @id @default(cuid())
  email           String     @unique
  name            String?
  password        String?
  emailVerified   DateTime?
  emailVerifiedAt DateTime?
  image           String?
  role            String     @default("user")
  status          UserStatus @default(ACTIVE)
  trustLevel      TrustLevel @default(GUEST)
  phoneNumber     String?
  phoneVerified   Boolean    @default(false)
  lastActiveAt    DateTime?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  // Relations
  accounts              Account[]
  sessions              Session[]
  userSessions          UserSession[]
  wallets               Wallet[]
  profile               UserProfile?
  addresses             UserAddress[]
  passwordHistory       PasswordHistory[]
  securityLogs          SecurityLog[]
  passwordResetToken    PasswordResetToken?
  twoFactorAuth         TwoFactorAuth?
  backupCodes           BackupCode[]
  trustedDevices        TrustedDevice[]
  apiKeys               ApiKey[]
  calendarEvents        ClientCalendar[]
  notificationPrefs     NotificationPreferences?
  ownedOrganizations    Organization[]         @relation("OrgOwner")
  memberships           OrganizationMember[]
  freezes               AccountFreeze[]
  deletionRequest       AccountDeletion?
  bans                  UserBan[]
  connectedAccounts     ConnectedAccount[]
  bansIssued            UserBan[]              @relation("BannedByUser")
  bansLifted            UserBan[]              @relation("UnbannedByUser")
  emailLogs             EmailLog[]
  uploads               Upload[]
  referralCode          ReferralCode?
  payoutRequests        PayoutRequest[]
  usageAlerts           UsageAlert[]
  npsSurveys            NpsSurvey[]

  @@index([email])
  @@index([status])
  @@index([createdAt])
  @@index([lastActiveAt])
  @@index([email, status]) // Composite for auth checks
  @@index([status, createdAt]) // For filtered listings
}

model UserProfile {
  id                  String    @id @default(cuid())
  userId              String    @unique
  firstName           String?
  lastName            String?
  avatar              String?
  bio                 String?
  position            String?
  birthDate           DateTime?
  birthMonth          Int?      // 1-12 for birthday celebrations
  birthDay            Int?      // 1-31 for birthday celebrations
  birthDateChangedAt  DateTime? // Max 1 change per year
  birthDateVisibility String    @default("private") // private, friends, public
  language            String    @default("tr")
  currency            String    @default("EUR")
  timezone            String    @default("Europe/Istanbul")
  dateFormat          String    @default("DD/MM/YYYY")
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model UserAddress {
  id         String      @id @default(cuid())
  userId     String
  type       AddressType @default(HOME)
  label      String?     // Custom label like "Office", "Home"
  title      String?
  line1      String
  line2      String?
  city       String
  state      String?
  country    String
  postalCode String?
  isDefault  Boolean     @default(false)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model PasswordHistory {
  id           String   @id @default(cuid())
  userId       String
  passwordHash String
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model LoginAttempt {
  id         String   @id @default(cuid())
  email      String
  ipAddress  String?
  userAgent  String?
  success    Boolean
  failReason String?
  platform   Platform @default(HYBLE)
  createdAt  DateTime @default(now())

  @@index([email])
  @@index([ipAddress])
  @@index([createdAt])
  @@index([email, createdAt])
  @@index([ipAddress, createdAt])
}

model SecurityLog {
  id        String         @id @default(cuid())
  userId    String
  action    SecurityAction
  ipAddress String?
  userAgent String?
  device    String?
  location  String?
  platform  Platform       @default(HYBLE)
  status    SecurityStatus
  metadata  Json?
  createdAt DateTime       @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@index([userId, createdAt])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

enum DeviceType {
  DESKTOP
  MOBILE
  TABLET
  UNKNOWN
}

model UserSession {
  id             String     @id @default(cuid())
  userId         String
  sessionToken   String     @unique
  deviceName     String?
  deviceType     DeviceType @default(UNKNOWN)
  browser        String?
  browserVersion String?
  os             String?
  osVersion      String?
  ipAddress      String?
  location       String?
  platform       Platform   @default(HYBLE)
  lastActiveAt   DateTime   @default(now())
  createdAt      DateTime   @default(now())
  expiresAt      DateTime
  isRevoked      Boolean    @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionToken])
  @@index([lastActiveAt])
}

model Wallet {
  id           String   @id @default(cuid())
  userId       String
  balance      Decimal  @default(0) @db.Decimal(18, 2) // Toplam bakiye (main + bonus + promo)
  mainBalance  Decimal  @default(0) @db.Decimal(18, 2) // Ana bakiye (para yükleme ile)
  bonusBalance Decimal  @default(0) @db.Decimal(18, 2) // Bonus bakiye (kampanyalar)
  promoBalance Decimal  @default(0) @db.Decimal(18, 2) // Promo bakiye (ilk kayıt bonusu vb.)
  currency     String   @default("EUR")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@unique([userId, currency])
  @@index([userId])
}

// ==================== BILLING ====================

enum TransactionType {
  DEPOSIT          // Para yükleme
  CHARGE           // Hizmet ücreti
  REFUND           // İade
  ADJUSTMENT       // Manuel düzeltme
  BONUS            // Bonus/Promosyon
}

enum TransactionStatus {
  PENDING          // İşlem bekliyor
  COMPLETED        // Tamamlandı
  FAILED           // Başarısız
  CANCELLED        // İptal edildi
  REFUNDED         // İade edildi
}

enum PaymentMethod {
  STRIPE           // Stripe ödeme
  PAYTR            // PayTR ödeme
  PAPARA           // Papara ödeme
  BANK_TRANSFER    // Banka havalesi
  WALLET           // Cüzdan ödemesi
  MANUAL           // Manuel (admin)
  SYSTEM           // Sistem otomatik
}

// Bakiye türü - harcama önceliği için
enum BalanceType {
  MAIN             // Ana bakiye
  BONUS            // Bonus bakiye
  PROMO            // Promosyon bakiye
}

model Transaction {
  id              String            @id @default(cuid())
  walletId        String
  type            TransactionType
  status          TransactionStatus @default(PENDING)
  amount          Decimal           @db.Decimal(18, 2)
  balanceBefore   Decimal           @db.Decimal(18, 2)
  balanceAfter    Decimal           @db.Decimal(18, 2)
  currency        String            @default("EUR")
  description     String
  reference       String?           // Stripe payment intent ID veya fatura no
  paymentMethod   PaymentMethod?
  balanceType     BalanceType?      // Hangi bakiye türünden düşüldü
  metadata        Json?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  wallet  Wallet   @relation(fields: [walletId], references: [id], onDelete: Cascade)
  invoice Invoice?

  @@index([walletId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@index([reference])
}

enum InvoiceStatus {
  DRAFT            // Taslak
  PENDING          // Ödeme bekliyor
  PAID             // Ödendi
  OVERDUE          // Gecikmiş
  CANCELLED        // İptal edildi
  REFUNDED         // İade edildi
}

model Invoice {
  id              String        @id @default(cuid())
  transactionId   String?       @unique
  invoiceNumber   String        @unique
  userId          String
  organizationId  String?
  status          InvoiceStatus @default(DRAFT)
  subtotal        Decimal       @db.Decimal(18, 2)
  taxRate         Decimal       @default(0) @db.Decimal(5, 2)
  taxAmount       Decimal       @default(0) @db.Decimal(18, 2)
  total           Decimal       @db.Decimal(18, 2)
  currency        String        @default("EUR")
  dueDate         DateTime?
  paidAt          DateTime?
  notes           String?
  billingAddress  Json?         // Snapshot of billing address at time of invoice
  items           Json          // Array of line items
  metadata        Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  transaction Transaction? @relation(fields: [transactionId], references: [id])

  @@index([userId])
  @@index([organizationId])
  @@index([status])
  @@index([createdAt])
  @@index([invoiceNumber])
  @@index([userId, status, createdAt]) // Composite for user invoice listings
  @@index([status, dueDate]) // For overdue processing
}

model StripeCustomer {
  id               String   @id @default(cuid())
  userId           String   @unique
  stripeCustomerId String   @unique
  defaultPaymentMethod String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([stripeCustomerId])
}

model VerificationToken {
  id         String   @id @default(cuid())
  identifier String
  token      String   @unique
  type       String   @default("email")
  expires    DateTime
  createdAt  DateTime @default(now())

  @@unique([identifier, token])
  @@index([identifier])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String   @unique
  expires   DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model TwoFactorAuth {
  id        String   @id @default(cuid())
  userId    String   @unique
  secret    String
  enabled   Boolean  @default(false)
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model BackupCode {
  id        String    @id @default(cuid())
  userId    String
  code      String
  used      Boolean   @default(false)
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ==================== ORGANIZATION ====================

model Organization {
  id          String    @id @default(cuid())
  ownerId     String
  name        String
  slug        String    @unique
  logo        String?
  description String?
  website     String?

  // Business info
  taxId         String?
  vatNumber     String?
  vatVerified   Boolean   @default(false)
  vatVerifiedAt DateTime?
  foundingDate  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  owner          User                 @relation("OrgOwner", fields: [ownerId], references: [id])
  members        OrganizationMember[]
  invites        OrganizationInvite[]
  domains        OrganizationDomain[]
  apiKeys        ApiKey[]
  ssoConfig      SsoConfiguration?
  calendarEvents ClientCalendar[]

  @@index([slug])
  @@index([ownerId])
}

model OrganizationMember {
  id             String           @id @default(cuid())
  organizationId String
  userId         String
  role           OrganizationRole @default(MEMBER)
  invitedBy      String?
  joinedAt       DateTime         @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
  @@index([organizationId, role]) // For role-based filtering
}

model OrganizationInvite {
  id             String           @id @default(cuid())
  organizationId String
  email          String
  role           OrganizationRole @default(MEMBER)
  status         InviteStatus     @default(PENDING)
  invitedBy      String
  token          String           @unique @default(cuid())
  expiresAt      DateTime
  acceptedAt     DateTime?
  createdAt      DateTime         @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, email])
  @@index([organizationId])
  @@index([email])
  @@index([token])
}

model OrganizationDomain {
  id                String    @id @default(cuid())
  organizationId    String
  domain            String    @unique
  verified          Boolean   @default(false)
  verificationToken String
  verifiedAt        DateTime?
  createdAt         DateTime  @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

// ==================== TRUSTED DEVICES ====================

model TrustedDevice {
  id          String   @id @default(cuid())
  userId      String
  fingerprint String
  name        String   // "Windows 10 - Chrome"
  lastUsed    DateTime @default(now())
  expiresAt   DateTime
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, fingerprint])
  @@index([userId])
}

// ==================== API KEYS ====================

model ApiKey {
  id                 String    @id @default(cuid())
  userId             String?
  organizationId     String?
  name               String
  keyHash            String    @unique
  keyPrefix          String    // First 8 chars for identification
  scopes             String[]
  ipWhitelist        String[]
  allowedIps         String[]
  allowedOrigins     String[]
  rateLimitPerMinute Int       @default(60)
  rateLimitPerDay    Int       @default(10000)
  lastUsed           DateTime?
  lastUsedAt         DateTime?
  expiresAt          DateTime?
  revokedAt          DateTime?
  createdAt          DateTime  @default(now())

  user         User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  usageLogs    ApiKeyUsage[]

  @@index([keyHash])
  @@index([userId])
  @@index([organizationId])
  @@index([revokedAt])
}

model ApiKeyUsage {
  id           String   @id @default(cuid())
  apiKeyId     String
  endpoint     String
  method       String
  ipAddress    String?
  statusCode   Int
  responseTime Int?     // Response time in milliseconds
  createdAt    DateTime @default(now())

  apiKey ApiKey @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)

  @@index([apiKeyId, createdAt])
}

// ==================== SSO CONFIGURATION ====================

model SsoConfiguration {
  id             String           @id @default(cuid())
  organizationId String           @unique
  provider       String           // okta, azure_ad, google, onelogin, custom_saml
  metadataUrl    String?
  metadataXml    String?          @db.Text
  entityId       String?
  ssoUrl         String?
  certificate    String?          @db.Text
  attributeMapping Json?
  defaultRole    OrganizationRole @default(MEMBER)
  jitProvisioning Boolean         @default(true)
  enabled        Boolean          @default(false)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

// ==================== APPRECIATION PROGRAM ====================

model ClientCalendar {
  id                 String            @id @default(cuid())
  userId             String?
  organizationId     String?
  eventType          CalendarEventType
  eventDate          DateTime
  lastCelebratedYear Int?
  celebrationCount   Int               @default(0)
  createdAt          DateTime          @default(now())

  user         User?            @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization?    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  celebrations CelebrationLog[]

  @@unique([userId, eventType])
  @@unique([organizationId, eventType])
  @@index([eventDate])
}

model CelebrationLog {
  id            String    @id @default(cuid())
  calendarId    String
  userId        String?   // For quick lookup
  year          Int
  type          String    // email, panel_notification, coupon
  emailSentAt   DateTime?
  emailOpenedAt DateTime?
  couponCode    String?
  couponUsed    Boolean   @default(false)
  couponUsedAt  DateTime?
  createdAt     DateTime  @default(now())

  calendar ClientCalendar @relation(fields: [calendarId], references: [id], onDelete: Cascade)

  @@index([calendarId])
  @@index([userId, year])
}

// ==================== ACCOUNT MANAGEMENT ====================

model AccountFreeze {
  id         String    @id @default(cuid())
  userId     String
  reason     String    // vacation, security, other
  note       String?
  frozenAt   DateTime  @default(now())
  unfrozenAt DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model AccountDeletion {
  id          String                @id @default(cuid())
  userId      String                @unique
  status      AccountDeletionStatus @default(PENDING)
  requestedAt DateTime              @default(now())
  scheduledAt DateTime              // 14 days from request
  cancelledAt DateTime?
  completedAt DateTime?
  reason      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([scheduledAt])
}

// ==================== ADMIN ====================

model AdminAction {
  id           String   @id @default(cuid())
  adminId      String
  targetUserId String?
  targetOrgId  String?
  action       String   // ban, unban, impersonate, verify, etc.
  reason       String?
  evidence     String?
  details      Json?
  createdAt    DateTime @default(now())

  @@index([adminId])
  @@index([targetUserId])
  @@index([createdAt])
}

model UserBan {
  id           String       @id @default(cuid())
  userId       String
  type         BanType
  scope        BanScope     @default(SERVICE)
  serviceType  ServiceType? // Which service type is banned (null if ecosystem-wide)
  platform     Platform?    // Which platform (Studios, Digital, Cloud)
  reason       String
  evidence     String?
  bannedBy     String
  active       Boolean      @default(true)
  expiresAt    DateTime?    // null for permanent
  liftedAt     DateTime?
  liftedBy     String?
  unbannedAt   DateTime?
  unbannedById String?
  createdAt    DateTime     @default(now())

  user           User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  bannedByUser   User? @relation("BannedByUser", fields: [bannedBy], references: [id])
  unbannedByUser User? @relation("UnbannedByUser", fields: [unbannedById], references: [id])

  @@index([userId])
  @@index([expiresAt])
  @@index([active])
  @@index([scope])
  @@index([serviceType])
}

// ==================== NOTIFICATIONS ====================

model NotificationPreferences {
  id     String @id @default(cuid())
  userId String @unique

  // Can't be turned off (always true)
  securityEmail Boolean @default(true)
  securityPanel Boolean @default(true)

  // Default on
  billingEmail  Boolean @default(true)
  billingPanel  Boolean @default(true)
  projectsEmail Boolean @default(true)
  projectsPanel Boolean @default(true)
  supportEmail  Boolean @default(true)
  supportPanel  Boolean @default(true)

  // Default off
  updatesEmail   Boolean @default(false)
  updatesPanel   Boolean @default(false)
  marketingEmail Boolean @default(false)
  marketingPanel Boolean @default(false)

  // Discord
  discordDm Boolean @default(false)

  // Appreciation
  appreciationEmail Boolean @default(true)

  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ==================== CONNECTED ACCOUNTS ====================

model ConnectedAccount {
  id                String   @id @default(cuid())
  userId            String
  provider          String   // google, github, discord, etc.
  providerAccountId String
  email             String?
  name              String?
  avatar            String?
  accessToken       String?  @db.Text
  refreshToken      String?  @db.Text
  expiresAt         DateTime?
  connectedAt       DateTime @default(now())
  lastUsedAt        DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@index([provider])
}

// ==================== EMAIL LOGS ====================

enum EmailStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
  BOUNCED
  COMPLAINED
  OPENED
  CLICKED
}

enum EmailType {
  VERIFICATION
  RESET_PASSWORD
  WELCOME
  INVOICE
  TICKET_REPLY
  ORG_INVITE
  SECURITY_ALERT
  MARKETING
  SYSTEM_ALERT
}

model EmailLog {
  id           String      @id @default(cuid())
  userId       String?
  resendId     String?     // Resend tarafından dönen ID
  type         EmailType
  recipient    String      // Statik email (user.email değişirse log bozulmasın)
  subject      String
  status       EmailStatus @default(PENDING)
  error        String?     // Hata mesajı varsa
  metadata     Json?       // Ek bilgiler (template data vb.)
  openedAt     DateTime?
  clickedAt    DateTime?
  deliveredAt  DateTime?
  bouncedAt    DateTime?
  complainedAt DateTime?
  sentAt       DateTime    @default(now())
  createdAt    DateTime    @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([resendId])
  @@index([recipient])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

// ==================== FAZ2-PIM: PRODUCT INFORMATION MANAGEMENT ====================

enum ProductType {
  DIGITAL       // Dijital ürün (tema, SDK, dosya)
  SUBSCRIPTION  // Abonelik bazlı hizmet
  BUNDLE        // Paket ürün
  SERVICE       // Tek seferlik hizmet
}

enum ProductStatus {
  DRAFT         // Taslak (yayında değil)
  ACTIVE        // Aktif (satışta)
  ARCHIVED      // Arşivlenmiş (satışta değil)
}

enum StockType {
  UNLIMITED     // Sınırsız stok (dijital ürünler)
  LIMITED       // Sınırlı stok
  CAPACITY      // Kapasite bazlı (örn: max 100 kullanıcı)
}

model Category {
  id          String     @id @default(cuid())
  parentId    String?
  parent      Category?  @relation("CategoryTree", fields: [parentId], references: [id], onDelete: SetNull)
  children    Category[] @relation("CategoryTree")

  nameTr      String
  nameEn      String
  slug        String     @unique
  icon        String?    // Lucide icon name
  description String?    @db.Text

  sortOrder   Int        @default(0)
  isActive    Boolean    @default(true)

  products    Product[]

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([parentId])
  @@index([slug])
  @@index([sortOrder])
}

model Product {
  id            String        @id @default(cuid())
  type          ProductType
  status        ProductStatus @default(DRAFT)

  categoryId    String?
  category      Category?     @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  // Satıcı (3. parti geliştirici için)
  sellerId      String?
  seller        Seller?       @relation("SellerProducts", fields: [sellerId], references: [id], onDelete: SetNull)

  // Temel Bilgiler (i18n - Türkçe/İngilizce)
  nameTr        String
  nameEn        String
  slug          String        @unique
  descriptionTr String?       @db.Text
  descriptionEn String?       @db.Text
  shortDescTr   String?       // Kısa açıklama (liste görünümü için)
  shortDescEn   String?

  // Hedef Kitle ve Etiketler
  targetAudience String[]     // ["startup", "smb", "enterprise"]
  tags           String[]

  // Fiyatlandırma (Varyant yoksa baz fiyat)
  basePrice     Decimal?      @db.Decimal(10, 2)
  currency      String        @default("EUR")
  taxRate       Decimal       @db.Decimal(5, 2) @default(20)

  // Öne Çıkarma
  isFeatured    Boolean       @default(false)
  featuredOrder Int?

  // Demo/Preview URL (canlı önizleme için)
  demoUrl       String?

  // Relations
  variants      ProductVariant[]
  media         ProductMedia[]
  videos        ProductVideo[]
  views360      Product360View[]
  meta          ProductMeta?
  relations     ProductRelation[] @relation("SourceProduct")
  relatedTo     ProductRelation[] @relation("RelatedProduct")

  // Bundle için
  bundleItems   BundleItem[]  @relation("BundleProduct")
  includedIn    BundleItem[]  @relation("IncludedProduct")

  // Marketplace features
  reviews       ProductReview[]
  rating        ProductRating?
  licenses      ProductLicense[]

  // Audit
  createdBy     String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([categoryId])
  @@index([sellerId])
  @@index([status])
  @@index([type])
  @@index([slug])
  @@index([isFeatured])
}

model ProductVariant {
  id            String    @id @default(cuid())
  productId     String
  product       Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  sku           String    @unique
  name          String    // "Starter", "Business", "Enterprise"

  price         Decimal   @db.Decimal(10, 2)
  currency      String    @default("EUR")

  // Özellik matrisi (JSON) - örn: { "ram": "4GB", "disk": "50GB", "ssl": true }
  features      Json?

  // Stok Yönetimi
  stockType     StockType @default(UNLIMITED)
  stockQty      Int?      // LIMITED için mevcut stok
  reservedQty   Int       @default(0) // Sepette bekleyen

  // Abonelik için
  billingPeriod String?   // monthly, quarterly, annually

  // Sıralama ve Varsayılan
  sortOrder     Int       @default(0)
  isDefault     Boolean   @default(false)
  isActive      Boolean   @default(true)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([productId])
  @@index([sku])
  @@index([isActive])
}

// ==================== ADVANCED PRODUCT MEDIA SYSTEM ====================

enum MediaType {
  IMAGE           // Standart görsel
  VIDEO           // Video içerik
  THUMBNAIL       // Küçük resim
  BANNER          // Banner görsel
  ICON            // İkon
  GALLERY         // Galeri görseli
  VARIANT         // Varyant görseli
  VIEW_360        // 360° görünüm
  LIFESTYLE       // Yaşam tarzı görseli
  SIZE_CHART      // Beden tablosu
  INFOGRAPHIC     // İnfografik
}

enum MediaStatus {
  PENDING         // Yükleniyor/İşleniyor
  PROCESSING      // Optimizasyon aşamasında
  READY           // Hazır
  FAILED          // Başarısız
  ARCHIVED        // Arşivlenmiş
}

enum MediaSource {
  UPLOAD          // Manuel yükleme
  URL             // Harici URL
  AI_GENERATED    // AI tarafından oluşturulmuş
  STUDIO          // Hyble Studios'dan
}

model ProductMedia {
  id          String      @id @default(cuid())
  productId   String
  product     Product     @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Varyant ilişkisi (opsiyonel)
  variantId   String?
  variantValue String?    // "red", "blue", "xl" gibi varyant değeri

  // Temel Bilgiler
  type        MediaType   @default(IMAGE)
  status      MediaStatus @default(PENDING)
  source      MediaSource @default(UPLOAD)

  // URL'ler (farklı boyutlar için)
  originalUrl String      // Orijinal yüklenen dosya
  url         String      // Ana kullanım URL'i (optimized)
  thumbnailUrl String?    // Küçük resim (150x150)
  mediumUrl   String?     // Orta boy (600x600)
  largeUrl    String?     // Büyük boy (1200x1200)
  webpUrl     String?     // WebP formatı
  avifUrl     String?     // AVIF formatı (en iyi sıkıştırma)

  // SEO & Erişilebilirlik
  alt         String?     // Alt text
  title       String?     // Hover title
  caption     String?     // Görsel açıklaması

  // Teknik Bilgiler
  width       Int?        // Orijinal genişlik
  height      Int?        // Orijinal yükseklik
  fileSize    Int?        // Byte cinsinden
  mimeType    String?     // image/jpeg, image/png, video/mp4
  aspectRatio String?     // "16:9", "1:1", "4:3"

  // Blur Hash (placeholder için)
  blurHash    String?     // 20-30 karakter blur hash
  dominantColor String?   // Hex renk kodu (#FF5733)
  colorPalette String[]   // En çok kullanılan renkler

  // AI Özellikleri
  aiTags      String[]    // AI tarafından oluşturulan etiketler
  aiDescription String?   // AI tarafından oluşturulan açıklama
  qualityScore Int?       // 0-100 arası kalite skoru
  isBackgroundRemoved Boolean @default(false)

  // Sıralama & Öne Çıkarma
  sortOrder   Int         @default(0)
  isPrimary   Boolean     @default(false)
  isHover     Boolean     @default(false) // Hover'da gösterilecek görsel
  isFeatured  Boolean     @default(false) // Öne çıkan görsel

  // R2 Storage
  r2Key       String?     // Cloudflare R2 key
  r2Bucket    String?     // Bucket adı

  // Metadata
  exifData    Json?       // EXIF bilgileri (kamera, tarih vb.)
  metadata    Json?       // Ek metadata

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([productId])
  @@index([variantId])
  @@index([type])
  @@index([status])
  @@index([sortOrder])
  @@index([isPrimary])
}

// 360° Görünüm için özel model
model Product360View {
  id          String    @id @default(cuid())
  productId   String
  product     Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Görünüm bilgileri
  name        String?   // "Ürün 360° Görünümü"
  frameCount  Int       // Toplam kare sayısı (örn: 36)
  autoRotate  Boolean   @default(true)
  rotationSpeed Int     @default(50) // ms cinsinden

  // Kontrol ayarları
  enableZoom  Boolean   @default(true)
  maxZoom     Float     @default(3.0)
  enableDrag  Boolean   @default(true)
  dragSensitivity Float @default(1.0)

  // Görsel bilgileri
  baseUrl     String    // Temel URL (frame numarası eklenir)
  format      String    @default("jpg") // jpg, png, webp
  width       Int?
  height      Int?

  // Preload
  preloadAll  Boolean   @default(false)
  lowResUrls  String[]  // Düşük çözünürlüklü önizlemeler

  isActive    Boolean   @default(true)
  sortOrder   Int       @default(0)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([productId])
  @@index([isActive])
}

// Video içerik için özel model
model ProductVideo {
  id          String      @id @default(cuid())
  productId   String
  product     Product     @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Video bilgileri
  title       String?
  description String?     @db.Text

  // URL'ler
  url         String      // Ana video URL
  hlsUrl      String?     // HLS streaming URL
  dashUrl     String?     // DASH streaming URL
  thumbnailUrl String?    // Video thumbnail
  posterUrl   String?     // Poster image

  // Platform entegrasyonları
  youtubeId   String?     // YouTube video ID
  vimeoId     String?     // Vimeo video ID
  wistiaId    String?     // Wistia video ID

  // Teknik bilgiler
  duration    Int?        // Saniye cinsinden
  width       Int?
  height      Int?
  fileSize    Int?
  mimeType    String?
  codec       String?     // h264, h265, vp9
  bitrate     Int?        // kbps

  // Ayarlar
  autoPlay    Boolean     @default(false)
  loop        Boolean     @default(false)
  muted       Boolean     @default(true)
  controls    Boolean     @default(true)

  // Durumu
  status      MediaStatus @default(PENDING)
  processingProgress Int? // 0-100 arası işleme durumu

  // Sıralama
  isPrimary   Boolean     @default(false)
  sortOrder   Int         @default(0)

  // R2 Storage
  r2Key       String?
  r2Bucket    String?

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([productId])
  @@index([status])
  @@index([isPrimary])
}

// Görsel işleme kuyruğu
model MediaProcessingJob {
  id          String    @id @default(cuid())
  mediaId     String    // ProductMedia ID
  mediaType   String    // "ProductMedia", "ProductVideo", "Product360View"

  // İşlem türleri
  jobType     String    // resize, optimize, webp, avif, blur_hash, ai_tag, remove_bg
  priority    Int       @default(5) // 1-10 arası öncelik

  // Durum
  status      String    @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  progress    Int       @default(0) // 0-100

  // Hata takibi
  attempts    Int       @default(0)
  maxAttempts Int       @default(3)
  lastError   String?

  // Sonuç
  result      Json?     // İşlem sonucu (URL'ler, hash'ler vb.)

  // Zamanlama
  scheduledAt DateTime  @default(now())
  startedAt   DateTime?
  completedAt DateTime?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([status])
  @@index([priority])
  @@index([mediaId])
  @@index([scheduledAt])
}

model ProductMeta {
  id            String  @id @default(cuid())
  productId     String  @unique
  product       Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // SEO Meta Tags (i18n)
  metaTitleTr   String?
  metaTitleEn   String?
  metaDescTr    String?
  metaDescEn    String?

  // Open Graph
  ogImage       String?

  // Schema.org Product (JSON-LD)
  schemaJson    Json?

  // Canonical URL (duplicate content önlemi)
  canonicalUrl  String?

  // Anahtar Kelimeler
  keywordsTr    String[]
  keywordsEn    String[]
}

model ProductRelation {
  id          String  @id @default(cuid())

  productId   String
  product     Product @relation("SourceProduct", fields: [productId], references: [id], onDelete: Cascade)

  relatedId   String
  relatedProduct Product @relation("RelatedProduct", fields: [relatedId], references: [id], onDelete: Cascade)

  type        String  // upsell, crosssell, accessory, similar

  sortOrder   Int     @default(0)

  @@unique([productId, relatedId, type])
  @@index([productId])
  @@index([relatedId])
}

model BundleItem {
  id                String  @id @default(cuid())

  bundleProductId   String
  bundleProduct     Product @relation("BundleProduct", fields: [bundleProductId], references: [id], onDelete: Cascade)

  includedProductId String
  includedProduct   Product @relation("IncludedProduct", fields: [includedProductId], references: [id], onDelete: Restrict)

  quantity          Int     @default(1)
  individualValue   Decimal @db.Decimal(10, 2) // Bireysel değer (tasarruf hesabı için)

  sortOrder         Int     @default(0)

  @@unique([bundleProductId, includedProductId])
  @@index([bundleProductId])
}

// ==================== FAZ3: CART & ORDER SYSTEM ====================

enum CartStatus {
  ACTIVE        // Aktif sepet
  CHECKOUT      // Ödeme aşamasında
  CONVERTED     // Siparişe dönüştürüldü
  ABANDONED     // Terk edilmiş
}

model Cart {
  id            String      @id @default(cuid())
  userId        String?
  sessionId     String?     // Guest kullanıcılar için
  status        CartStatus  @default(ACTIVE)

  // Kupon
  couponId      String?
  coupon        Coupon?     @relation(fields: [couponId], references: [id], onDelete: SetNull)
  couponCode    String?
  discountAmount Decimal    @default(0) @db.Decimal(10, 2)

  // Totals (cache, checkout anında hesaplanır)
  subtotal      Decimal     @default(0) @db.Decimal(10, 2)
  taxAmount     Decimal     @default(0) @db.Decimal(10, 2)
  total         Decimal     @default(0) @db.Decimal(10, 2)
  currency      String      @default("EUR")

  // Meta
  ipAddress     String?
  userAgent     String?

  expiresAt     DateTime?   // Guest sepetler için son kullanma
  convertedAt   DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  items         CartItem[]
  order         Order?

  @@unique([userId, status]) // Kullanıcı başına sadece 1 aktif sepet
  @@index([sessionId])
  @@index([status])
  @@index([expiresAt])
}

model CartItem {
  id            String    @id @default(cuid())
  cartId        String
  cart          Cart      @relation(fields: [cartId], references: [id], onDelete: Cascade)

  productId     String
  variantId     String?   // ProductVariant ID (varsa)
  quantity      Int       @default(1)

  // Snapshot (sepete eklendiğindeki fiyat)
  unitPrice     Decimal   @db.Decimal(10, 2)
  currency      String    @default("EUR")

  // Ürün bilgileri snapshot
  productName   String
  variantName   String?
  productSlug   String

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([cartId, productId, variantId])
  @@index([cartId])
}

enum OrderStatus {
  PENDING         // Ödeme bekleniyor
  PROCESSING      // İşleniyor
  COMPLETED       // Tamamlandı
  FAILED          // Başarısız
  CANCELLED       // İptal edildi
  REFUNDED        // İade edildi
  PARTIALLY_REFUNDED // Kısmi iade
}

enum PaymentStatus {
  PENDING         // Ödeme bekleniyor
  AUTHORIZED      // Yetkilendirildi
  CAPTURED        // Çekildi
  FAILED          // Başarısız
  REFUNDED        // İade edildi
  PARTIALLY_REFUNDED // Kısmi iade
}

model Order {
  id              String        @id @default(cuid())
  orderNumber     String        @unique // HYB-20250101-XXXX
  userId          String
  cartId          String?       @unique

  status          OrderStatus   @default(PENDING)
  paymentStatus   PaymentStatus @default(PENDING)

  // Finansallar
  subtotal        Decimal       @db.Decimal(10, 2)
  discountAmount  Decimal       @default(0) @db.Decimal(10, 2)
  taxRate         Decimal       @default(20) @db.Decimal(5, 2)
  taxAmount       Decimal       @db.Decimal(10, 2)
  total           Decimal       @db.Decimal(10, 2)
  currency        String        @default("EUR")

  // Ödeme bilgileri
  paymentMethod   String?       // wallet, stripe, bank_transfer
  paymentRef      String?       // Stripe PaymentIntent ID veya referans
  walletAmount    Decimal       @default(0) @db.Decimal(10, 2) // Cüzdandan ödenen
  cardAmount      Decimal       @default(0) @db.Decimal(10, 2) // Karttan ödenen

  // Kupon
  couponId        String?
  couponCode      String?

  // Fatura
  invoiceId       String?

  // Billing Address (snapshot)
  billingAddress  Json?

  // Shipping
  shippingInfo    Json?         // Carrier, tracking number, status etc.

  // Meta
  notes           String?
  ipAddress       String?
  userAgent       String?
  metadata        Json?         // Additional data

  paidAt          DateTime?
  completedAt     DateTime?
  cancelledAt     DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  cart            Cart?         @relation(fields: [cartId], references: [id])
  items           OrderItem[]
  subscriptions   Subscription[]

  @@index([userId])
  @@index([status])
  @@index([paymentStatus])
  @@index([orderNumber])
  @@index([createdAt])
}

model OrderItem {
  id            String    @id @default(cuid())
  orderId       String
  order         Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId     String
  variantId     String?
  quantity      Int

  // Snapshot
  unitPrice     Decimal   @db.Decimal(10, 2)
  totalPrice    Decimal   @db.Decimal(10, 2)
  currency      String    @default("EUR")

  productName   String
  variantName   String?
  productSlug   String

  // Subscription products
  isSubscription Boolean  @default(false)
  billingPeriod  String?  // monthly, quarterly, annually

  createdAt     DateTime  @default(now())

  @@index([orderId])
  @@index([productId])
}

// ==================== FAZ3: SUBSCRIPTION SYSTEM ====================

enum SubscriptionStatus {
  TRIAL           // Deneme süresi
  ACTIVE          // Aktif
  PAST_DUE        // Ödeme gecikmiş
  PAUSED          // Duraklatılmış
  CANCELLED       // İptal edilmiş
  EXPIRED         // Süresi dolmuş
}

model Subscription {
  id                String             @id @default(cuid())
  userId            String
  orderId           String?
  order             Order?             @relation(fields: [orderId], references: [id])

  productId         String
  variantId         String?

  status            SubscriptionStatus @default(ACTIVE)

  // Periyot
  billingPeriod     String             // monthly, quarterly, annually
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime

  // Fiyatlandırma
  price             Decimal            @db.Decimal(10, 2)
  currency          String             @default("EUR")

  // Trial
  trialStart        DateTime?
  trialEnd          DateTime?

  // Auto-renewal
  autoRenew         Boolean            @default(true)
  cancelAtPeriodEnd Boolean            @default(false)

  // External refs
  stripeSubscriptionId String?

  // Snapshot
  productName       String
  variantName       String?

  cancelledAt       DateTime?
  cancelReason      String?
  pausedAt          DateTime?
  pauseReason       String?
  resumesAt         DateTime?

  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  @@index([userId])
  @@index([status])
  @@index([currentPeriodEnd])
  @@index([stripeSubscriptionId])
}

// ==================== FAZ3: VOUCHER/COUPON SYSTEM ====================

enum CouponType {
  PERCENTAGE      // Yüzde indirim
  FIXED           // Sabit tutar
  FREE_SHIPPING   // Ücretsiz kargo (gelecek için)
}

enum CouponStatus {
  ACTIVE          // Aktif
  INACTIVE        // Pasif
  EXPIRED         // Süresi dolmuş
  DEPLETED        // Kullanım limiti dolmuş
}

model Coupon {
  id              String        @id @default(cuid())
  code            String        @unique
  description     String?

  type            CouponType
  status          CouponStatus  @default(ACTIVE)

  // Değer
  value           Decimal       @db.Decimal(10, 2) // Yüzde veya sabit tutar
  minOrderAmount  Decimal?      @db.Decimal(10, 2) // Minimum sipariş tutarı
  maxDiscount     Decimal?      @db.Decimal(10, 2) // Max indirim (yüzde için)

  // Kullanım limitleri
  usageLimit      Int?          // Toplam kullanım limiti
  usagePerUser    Int           @default(1) // Kullanıcı başına limit
  usedCount       Int           @default(0) // Toplam kullanılma sayısı

  // Geçerlilik
  startsAt        DateTime      @default(now())
  expiresAt       DateTime?

  // Kısıtlamalar
  productIds      String[]      // Sadece belirli ürünler için
  categoryIds     String[]      // Sadece belirli kategoriler için
  excludeProductIds String[]    // Hariç tutulan ürünler
  userIds         String[]      // Sadece belirli kullanıcılar için

  // Referans
  createdBy       String?
  campaign        String?       // Kampanya adı/ID

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  usages          CouponUsage[]
  carts           Cart[]

  @@index([code])
  @@index([status])
  @@index([expiresAt])
}

model CouponUsage {
  id          String    @id @default(cuid())
  couponId    String
  coupon      Coupon    @relation(fields: [couponId], references: [id], onDelete: Cascade)

  userId      String
  orderId     String?

  discountAmount Decimal @db.Decimal(10, 2)

  usedAt      DateTime  @default(now())

  @@unique([couponId, userId, orderId])
  @@index([couponId])
  @@index([userId])
}

// ==================== FAZ3: VOUCHER/GIFT CARDS ====================

enum VoucherType {
  GIFT_CARD       // Hediye kartı (bakiye yükler)
  PROMO_CREDIT    // Promosyon kredisi
  REFERRAL        // Referans bonusu
  BIRTHDAY        // Doğum günü hediyesi
}

enum VoucherStatus {
  ACTIVE          // Kullanılabilir
  USED            // Kullanılmış
  EXPIRED         // Süresi dolmuş
  CANCELLED       // İptal edilmiş
}

model Voucher {
  id            String        @id @default(cuid())
  code          String        @unique
  type          VoucherType
  status        VoucherStatus @default(ACTIVE)

  // Değer
  originalAmount Decimal      @db.Decimal(10, 2)
  remainingAmount Decimal     @db.Decimal(10, 2)
  currency      String        @default("EUR")

  // Kısıtlamalar
  userId        String?       // Belirli kullanıcıya özel
  minOrderAmount Decimal?     @db.Decimal(10, 2)

  // Geçerlilik
  expiresAt     DateTime?

  // Referans
  createdBy     String?
  reason        String?

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  redemptions   VoucherRedemption[]

  @@index([code])
  @@index([userId])
  @@index([status])
  @@index([expiresAt])
}

model VoucherRedemption {
  id          String    @id @default(cuid())
  voucherId   String
  voucher     Voucher   @relation(fields: [voucherId], references: [id], onDelete: Cascade)

  userId      String
  amount      Decimal   @db.Decimal(10, 2)
  type        String    // wallet_deposit, order_payment

  balanceBefore Decimal @db.Decimal(10, 2)
  balanceAfter  Decimal @db.Decimal(10, 2)

  redeemedAt  DateTime  @default(now())

  @@index([voucherId])
  @@index([userId])
}

// ==================== FAZ3: IN-APP NOTIFICATIONS ====================

enum NotificationType {
  SYSTEM          // Sistem bildirimi
  SECURITY        // Güvenlik uyarısı
  BILLING         // Fatura/Ödeme
  ORDER           // Sipariş durumu
  SUBSCRIPTION    // Abonelik bildirimi
  SUPPORT         // Destek talebi
  MARKETING       // Pazarlama
  ANNOUNCEMENT    // Duyuru
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

model Notification {
  id            String               @id @default(cuid())
  userId        String

  type          NotificationType
  priority      NotificationPriority @default(NORMAL)

  title         String
  message       String               @db.Text

  // Link/Action
  actionUrl     String?
  actionLabel   String?

  // Meta
  icon          String?              // Lucide icon name
  metadata      Json?

  // Status
  isRead        Boolean              @default(false)
  readAt        DateTime?
  isDismissed   Boolean              @default(false)
  dismissedAt   DateTime?

  // Expiry
  expiresAt     DateTime?

  createdAt     DateTime             @default(now())

  @@index([userId])
  @@index([isRead])
  @@index([type])
  @@index([createdAt])
  @@index([userId, isRead])
}

// ==================== FAZ3: SUPPORT TICKET SYSTEM ====================

enum TicketStatus {
  OPEN            // Açık
  AWAITING_REPLY  // Yanıt bekleniyor (müşteri)
  IN_PROGRESS     // İşleniyor
  ON_HOLD         // Beklemede
  RESOLVED        // Çözüldü
  CLOSED          // Kapatıldı
}

enum TicketPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum TicketCategory {
  BILLING         // Fatura/Ödeme
  TECHNICAL       // Teknik destek
  ACCOUNT         // Hesap sorunları
  SALES           // Satış öncesi
  FEEDBACK        // Geri bildirim
  BUG_REPORT      // Hata raporu
  FEATURE_REQUEST // Özellik talebi
  OTHER           // Diğer
}

model Ticket {
  id              String          @id @default(cuid())
  referenceNo     String          @unique // TKT-20250101-XXXX

  userId          String
  organizationId  String?

  subject         String
  category        TicketCategory
  status          TicketStatus    @default(OPEN)
  priority        TicketPriority  @default(NORMAL)

  // Assignment
  assignedTo      String?         // Admin user ID
  assignedAt      DateTime?

  // Related resources
  relatedOrderId  String?
  relatedProductId String?
  relatedSubscriptionId String?

  // Tags/Labels
  tags            String[]

  // Meta
  metadata        Json?
  ipAddress       String?
  userAgent       String?

  // SLA
  firstResponseAt DateTime?
  resolvedAt      DateTime?
  closedAt        DateTime?

  // Rating (after resolution)
  rating          Int?            // 1-5
  ratingComment   String?
  ratedAt         DateTime?

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  messages        TicketMessage[]
  attachments     TicketAttachment[]

  @@index([userId])
  @@index([organizationId])
  @@index([status])
  @@index([assignedTo])
  @@index([referenceNo])
  @@index([category])
  @@index([createdAt])
  @@index([userId, status, createdAt]) // Composite for user ticket listings
  @@index([status, priority, createdAt]) // For admin queue
}

model TicketMessage {
  id            String    @id @default(cuid())
  ticketId      String
  ticket        Ticket    @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  authorId      String    // User or Admin ID
  authorType    String    // user, admin, system
  authorName    String?   // Snapshot

  content       String    @db.Text

  // Internal note (only visible to admins)
  isInternal    Boolean   @default(false)

  // Auto-reply indicator
  isAutoReply   Boolean   @default(false)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  attachments   TicketAttachment[]

  @@index([ticketId])
  @@index([authorId])
  @@index([createdAt])
}

model TicketAttachment {
  id            String    @id @default(cuid())
  ticketId      String
  ticket        Ticket    @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  messageId     String?
  message       TicketMessage? @relation(fields: [messageId], references: [id], onDelete: SetNull)

  fileName      String
  fileSize      Int
  fileType      String
  fileUrl       String

  uploadedBy    String
  uploadedAt    DateTime  @default(now())

  @@index([ticketId])
  @@index([messageId])
}

// ==================== FAZ3: STATUS PAGE ====================

enum ServiceCategory {
  CORE            // Core services
  CLOUD           // Cloud hosting
  GAMING          // Game servers
  API             // API services
  BILLING         // Payment/Billing
  AUTH            // Authentication
}

enum ServiceHealthStatus {
  OPERATIONAL     // Çalışıyor
  DEGRADED        // Performans düşük
  PARTIAL_OUTAGE  // Kısmi kesinti
  MAJOR_OUTAGE    // Büyük kesinti
  MAINTENANCE     // Bakım
}

model ServiceStatus {
  id              String              @id @default(cuid())

  name            String              // "API Gateway", "Database", etc.
  slug            String              @unique
  description     String?
  category        ServiceCategory

  status          ServiceHealthStatus @default(OPERATIONAL)
  statusMessage   String?

  // Uptime tracking
  uptimePercent   Decimal             @default(100) @db.Decimal(5, 2)
  lastCheckedAt   DateTime            @default(now())
  lastIncidentAt  DateTime?

  // Display
  isPublic        Boolean             @default(true)
  sortOrder       Int                 @default(0)

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  incidents       Incident[]

  @@index([status])
  @@index([category])
  @@index([isPublic])
}

enum IncidentStatus {
  INVESTIGATING   // Araştırılıyor
  IDENTIFIED      // Tespit edildi
  MONITORING      // İzleniyor
  RESOLVED        // Çözüldü
}

enum IncidentImpact {
  NONE            // Etki yok
  MINOR           // Küçük etki
  MAJOR           // Büyük etki
  CRITICAL        // Kritik
}

model Incident {
  id              String          @id @default(cuid())

  title           String
  status          IncidentStatus  @default(INVESTIGATING)
  impact          IncidentImpact  @default(MINOR)

  // Affected services
  serviceIds      String[]
  services        ServiceStatus[] @relation

  // Timeline
  startedAt       DateTime        @default(now())
  resolvedAt      DateTime?

  // Investigation
  rootCause       String?         @db.Text
  resolution      String?         @db.Text

  // Postmortem
  postmortemUrl   String?

  // Visibility
  isPublic        Boolean         @default(true)

  createdBy       String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  updates         IncidentUpdate[]

  @@index([status])
  @@index([startedAt])
  @@index([isPublic])
}

model IncidentUpdate {
  id            String    @id @default(cuid())
  incidentId    String
  incident      Incident  @relation(fields: [incidentId], references: [id], onDelete: Cascade)

  status        IncidentStatus
  message       String    @db.Text

  createdBy     String?
  createdAt     DateTime  @default(now())

  @@index([incidentId])
  @@index([createdAt])
}

// ==================== FAZ3: SCHEDULED MAINTENANCE ====================

model ScheduledMaintenance {
  id              String          @id @default(cuid())

  title           String
  description     String          @db.Text

  // Affected services
  serviceIds      String[]

  // Schedule
  scheduledStart  DateTime
  scheduledEnd    DateTime

  // Actual times
  actualStart     DateTime?
  actualEnd       DateTime?

  // Status
  isCancelled     Boolean         @default(false)
  cancelReason    String?

  // Notifications sent
  notificationSentAt DateTime?
  reminderSentAt    DateTime?

  createdBy       String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([scheduledStart])
  @@index([isCancelled])
}

// ==================== FAZ2: DELIVERY SYSTEM ====================

enum DeliveryStatus {
  PENDING         // Teslimat bekleniyor
  PROCESSING      // İşleniyor
  DELIVERED       // Teslim edildi
  FAILED          // Başarısız
  REFUNDED        // İade edildi
}

enum DeliveryType {
  INSTANT         // Anında teslimat (dijital)
  SCHEDULED       // Zamanlanmış teslimat
  MANUAL          // Manuel teslimat
}

model Delivery {
  id              String          @id @default(cuid())

  orderId         String
  orderItemId     String
  userId          String

  type            DeliveryType    @default(INSTANT)
  status          DeliveryStatus  @default(PENDING)

  // Product info snapshot
  productId       String
  productName     String
  variantId       String?
  variantName     String?

  // Delivery content (encrypted if sensitive)
  deliveryData    Json?           // { licenseKey, downloadUrl, accessCredentials, etc. }

  // Access tracking
  accessCount     Int             @default(0)
  maxAccessCount  Int?            // null = unlimited
  accessExpiresAt DateTime?

  // Timestamps
  deliveredAt     DateTime?
  firstAccessedAt DateTime?
  lastAccessedAt  DateTime?

  // Error handling
  failureReason   String?
  retryCount      Int             @default(0)
  maxRetries      Int             @default(3)
  nextRetryAt     DateTime?

  // Meta
  metadata        Json?
  ipAddress       String?

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  accessLogs      DeliveryAccessLog[]

  @@index([orderId])
  @@index([userId])
  @@index([status])
  @@index([productId])
}

model DeliveryAccessLog {
  id            String    @id @default(cuid())
  deliveryId    String
  delivery      Delivery  @relation(fields: [deliveryId], references: [id], onDelete: Cascade)

  userId        String
  ipAddress     String?
  userAgent     String?

  action        String    // view, download, activate

  createdAt     DateTime  @default(now())

  @@index([deliveryId])
  @@index([userId])
  @@index([createdAt])
}

// ==================== FAZ2: PAYMENT GATEWAY RECORDS ====================

enum PaymentGateway {
  STRIPE
  PAYTR
  PAPARA
}

enum PaymentGatewayStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

model PaymentRecord {
  id                String               @id @default(cuid())

  userId            String
  orderId           String?
  walletId          String?

  gateway           PaymentGateway
  status            PaymentGatewayStatus @default(PENDING)

  // Amounts
  amount            Decimal              @db.Decimal(10, 2)
  currency          String               @default("TRY")
  fee               Decimal              @default(0) @db.Decimal(10, 2)
  netAmount         Decimal              @db.Decimal(10, 2)

  // Gateway references
  externalId        String?              // Gateway transaction ID
  externalStatus    String?              // Gateway status

  // PayTR specific
  paytrMerchantOid  String?
  paytrToken        String?

  // Papara specific
  paparaPaymentId   String?
  paparaAccountNumber String?

  // Stripe specific
  stripePaymentIntentId String?
  stripeChargeId        String?

  // Card info (masked)
  cardBrand         String?              // visa, mastercard
  cardLast4         String?
  cardHolderName    String?

  // Error handling
  errorCode         String?
  errorMessage      String?

  // Webhook data
  webhookReceivedAt DateTime?
  webhookData       Json?

  // Refund info
  refundedAmount    Decimal              @default(0) @db.Decimal(10, 2)
  refundedAt        DateTime?
  refundReason      String?

  // Meta
  ipAddress         String?
  userAgent         String?
  metadata          Json?

  completedAt       DateTime?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt

  @@index([userId])
  @@index([orderId])
  @@index([walletId])
  @@index([gateway])
  @@index([status])
  @@index([externalId])
  @@index([paytrMerchantOid])
  @@index([paparaPaymentId])
  @@index([stripePaymentIntentId])
}

// ==================== DIGITAL DELIVERY ====================

enum FileStatus {
  ACTIVE
  INACTIVE
  DELETED
}

model ProductFile {
  id            String      @id @default(cuid())
  productId     String
  variantId     String?

  // File info
  name          String      // Display name
  filename      String      // Original filename
  r2Key         String      @unique // R2 storage key
  r2Url         String      // Public URL (if public) or empty
  contentType   String      // MIME type
  size          Int         // File size in bytes

  // Version control
  version       String      @default("1.0.0")
  changelog     String?     @db.Text

  // Access control
  isPublic      Boolean     @default(false) // Public preview vs private download
  status        FileStatus  @default(ACTIVE)

  // Metadata
  checksum      String?     // MD5 or SHA256 hash for integrity
  metadata      Json?

  // Relations
  downloads     DownloadToken[]

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([productId])
  @@index([variantId])
  @@index([status])
}

model DownloadToken {
  id            String      @id @default(cuid())
  token         String      @unique @default(cuid())

  // Relations
  fileId        String
  file          ProductFile @relation(fields: [fileId], references: [id], onDelete: Cascade)
  userId        String
  orderId       String?     // Which order granted access
  licenseId     String?     // Which license granted access

  // Access control
  maxDownloads  Int         @default(5) // Max download attempts
  downloadCount Int         @default(0)
  expiresAt     DateTime    // Token expiration
  lastUsedAt    DateTime?
  ipAddress     String?     // IP that created/used the token

  // Audit
  createdAt     DateTime    @default(now())

  @@index([userId])
  @@index([fileId])
  @@index([orderId])
  @@index([licenseId])
  @@index([token])
  @@index([expiresAt])
}

// ==================== LICENSE MANAGEMENT ====================

enum LicenseStatus {
  ACTIVE
  SUSPENDED
  EXPIRED
  REVOKED
  PENDING
}

enum LicenseType {
  PERPETUAL     // Lifetime license
  SUBSCRIPTION  // Recurring subscription
  TRIAL         // Trial period
  DEVELOPER     // Developer/testing license
}

model License {
  id            String        @id @default(cuid())
  licenseKey    String        @unique

  // Relations
  userId        String
  productId     String
  variantId     String?
  orderId       String?       // Original purchase order

  // License details
  type          LicenseType   @default(PERPETUAL)
  status        LicenseStatus @default(PENDING)

  // Validity
  activatedAt   DateTime?
  expiresAt     DateTime?
  lastCheckedAt DateTime?

  // Usage limits
  maxActivations Int          @default(1)
  activationCount Int         @default(0)

  // Domain/IP binding
  allowedDomains String[]
  allowedIps     String[]

  // Metadata
  productName   String        // Cached product name
  variantName   String?
  metadata      Json?
  notes         String?       @db.Text

  // Relations
  activations   LicenseActivation[]

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([userId])
  @@index([productId])
  @@index([orderId])
  @@index([status])
  @@index([licenseKey])
  @@index([expiresAt])
}

model LicenseActivation {
  id            String    @id @default(cuid())
  licenseId     String
  license       License   @relation(fields: [licenseId], references: [id], onDelete: Cascade)

  // Device/environment info
  machineId     String?   // Hardware fingerprint
  hostname      String?
  domain        String?
  ipAddress     String
  userAgent     String?

  // Status
  isActive      Boolean   @default(true)
  deactivatedAt DateTime?
  deactivatedBy String?   // userId or "system"
  deactivateReason String?

  // Audit
  createdAt     DateTime  @default(now())

  @@index([licenseId])
  @@index([machineId])
  @@index([isActive])
}

// ==================== MARKETPLACE FEATURES ====================

// -------------------- PRODUCT REVIEWS & RATINGS --------------------

enum ReviewStatus {
  PENDING       // Onay bekliyor
  APPROVED      // Onaylandı
  REJECTED      // Reddedildi
  FLAGGED       // İşaretlendi (spam/uygunsuz)
}

model ProductReview {
  id            String        @id @default(cuid())

  productId     String
  product       Product       @relation(fields: [productId], references: [id], onDelete: Cascade)

  userId        String

  // Satın alma doğrulaması
  orderId       String?       // Hangi siparişten sonra yazıldı
  isVerifiedPurchase Boolean  @default(false)

  // Değerlendirme
  rating        Int           // 1-5 yıldız
  title         String?       // Yorum başlığı
  content       String        @db.Text // Yorum içeriği

  // Pros/Cons listesi
  pros          String[]      // Artılar
  cons          String[]      // Eksiler

  // Durum
  status        ReviewStatus  @default(PENDING)

  // Moderasyon
  moderatedBy   String?
  moderatedAt   DateTime?
  moderationNote String?

  // Faydalılık oyları
  helpfulCount  Int           @default(0)
  notHelpfulCount Int         @default(0)

  // Satıcı yanıtı
  sellerResponse String?      @db.Text
  sellerResponseAt DateTime?

  // Medya
  images        String[]      // Yorum görselleri

  // Meta
  ipAddress     String?
  userAgent     String?

  // Düzenleme geçmişi
  isEdited      Boolean       @default(false)
  editedAt      DateTime?

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  votes         ReviewVote[]
  reports       ReviewReport[]

  @@unique([productId, userId]) // Kullanıcı başına ürün için 1 yorum
  @@index([productId])
  @@index([userId])
  @@index([status])
  @@index([rating])
  @@index([createdAt])
}

model ReviewVote {
  id            String    @id @default(cuid())

  reviewId      String
  review        ProductReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  userId        String

  isHelpful     Boolean   // true = helpful, false = not helpful

  createdAt     DateTime  @default(now())

  @@unique([reviewId, userId]) // Kullanıcı başına yorum için 1 oy
  @@index([reviewId])
  @@index([userId])
}

model ReviewReport {
  id            String    @id @default(cuid())

  reviewId      String
  review        ProductReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  userId        String

  reason        String    // spam, inappropriate, fake, etc.
  description   String?   @db.Text

  // Moderasyon
  isResolved    Boolean   @default(false)
  resolvedBy    String?
  resolvedAt    DateTime?
  resolution    String?   // kept, removed, edited

  createdAt     DateTime  @default(now())

  @@unique([reviewId, userId]) // Kullanıcı başına yorum için 1 rapor
  @@index([reviewId])
  @@index([isResolved])
}

// Ürün rating özeti (performans için cache)
model ProductRating {
  id            String    @id @default(cuid())

  productId     String    @unique
  product       Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Ortalama ve toplam
  averageRating Decimal   @default(0) @db.Decimal(3, 2) // 0.00 - 5.00
  totalReviews  Int       @default(0)

  // Dağılım
  rating5Count  Int       @default(0)
  rating4Count  Int       @default(0)
  rating3Count  Int       @default(0)
  rating2Count  Int       @default(0)
  rating1Count  Int       @default(0)

  // Doğrulanmış satın alma oranı
  verifiedPurchaseCount Int @default(0)

  updatedAt     DateTime  @updatedAt
}

// -------------------- LICENSE TYPES (KİŞİSEL/TİCARİ/UZATILMIŞ) --------------------

enum LicenseTier {
  PERSONAL      // Kişisel kullanım
  COMMERCIAL    // Ticari kullanım (tek proje)
  EXTENDED      // Uzatılmış lisans (sınırsız proje)
  ENTERPRISE    // Kurumsal (özel anlaşma)
}

model ProductLicense {
  id            String      @id @default(cuid())

  productId     String
  product       Product     @relation(fields: [productId], references: [id], onDelete: Cascade)

  tier          LicenseTier

  // Fiyatlandırma
  price         Decimal     @db.Decimal(10, 2)
  currency      String      @default("EUR")

  // Kısıtlamalar
  maxProjects   Int?        // null = sınırsız
  maxUsers      Int?        // null = sınırsız
  maxDomains    Int?        // null = sınırsız

  // İzinler
  allowCommercial     Boolean @default(false)
  allowModification   Boolean @default(true)
  allowRedistribution Boolean @default(false)
  allowSublicense     Boolean @default(false)
  allowWhiteLabel     Boolean @default(false)

  // Destek
  supportMonths       Int     @default(0) // 0 = destek yok
  updatesMonths       Int     @default(12) // 12 = 1 yıl güncelleme

  // Açıklama
  description         String? @db.Text
  features            String[] // Lisansa özel özellikler

  isActive            Boolean @default(true)
  sortOrder           Int     @default(0)

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@unique([productId, tier])
  @@index([productId])
  @@index([tier])
}

// -------------------- SELLER/VENDOR PROFILES (SATICI PROFİLLERİ) --------------------

enum SellerStatus {
  PENDING       // Onay bekliyor
  ACTIVE        // Aktif satıcı
  SUSPENDED     // Askıya alınmış
  BANNED        // Yasaklanmış
}

enum SellerTier {
  STARTER       // Yeni satıcı
  BRONZE        // 10+ satış
  SILVER        // 50+ satış
  GOLD          // 200+ satış
  PLATINUM      // 500+ satış
  DIAMOND       // 1000+ satış
}

model Seller {
  id            String        @id @default(cuid())

  userId        String        @unique

  // Profil bilgileri
  displayName   String
  slug          String        @unique
  bio           String?       @db.Text
  avatar        String?
  coverImage    String?

  // İletişim
  publicEmail   String?
  website       String?

  // Sosyal medya
  socialLinks   Json?         // { twitter, github, linkedin, etc. }

  // Durum
  status        SellerStatus  @default(PENDING)
  tier          SellerTier    @default(STARTER)

  // Doğrulama
  isVerified    Boolean       @default(false)
  verifiedAt    DateTime?
  verificationBadge String?   // "identity", "business", "top_seller"

  // İstatistikler (cache)
  totalProducts Int           @default(0)
  totalSales    Int           @default(0)
  totalRevenue  Decimal       @default(0) @db.Decimal(18, 2)
  averageRating Decimal       @default(0) @db.Decimal(3, 2)

  // Komisyon oranı (%)
  commissionRate Decimal      @default(30) @db.Decimal(5, 2) // Platform komisyonu

  // Ödeme bilgileri
  payoutMethod  String?       // stripe, paypal, bank_transfer
  payoutDetails Json?         // Şifreli ödeme bilgileri

  // Tercihler
  notifyOnSale  Boolean       @default(true)
  notifyOnReview Boolean      @default(true)

  // Sözleşme
  agreedToTerms     Boolean   @default(false)
  agreedToTermsAt   DateTime?

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  products      Product[]     @relation("SellerProducts")
  payouts       SellerPayout[]

  @@index([userId])
  @@index([slug])
  @@index([status])
  @@index([tier])
}

model SellerPayout {
  id            String    @id @default(cuid())

  sellerId      String
  seller        Seller    @relation(fields: [sellerId], references: [id], onDelete: Cascade)

  // Tutar
  amount        Decimal   @db.Decimal(18, 2)
  fee           Decimal   @default(0) @db.Decimal(18, 2) // Transfer ücreti
  netAmount     Decimal   @db.Decimal(18, 2)
  currency      String    @default("EUR")

  // Durum
  status        String    @default("pending") // pending, processing, completed, failed

  // Ödeme detayları
  payoutMethod  String    // stripe, paypal, bank_transfer
  payoutRef     String?   // Harici referans numarası

  // Dönem
  periodStart   DateTime
  periodEnd     DateTime

  // İşlem tarihleri
  requestedAt   DateTime  @default(now())
  processedAt   DateTime?
  completedAt   DateTime?

  // Notlar
  notes         String?
  failureReason String?

  @@index([sellerId])
  @@index([status])
  @@index([requestedAt])
}

// -------------------- AFFILIATE/REFERRAL SYSTEM (KOMİSYON SİSTEMİ) --------------------

enum AffiliateStatus {
  PENDING       // Onay bekliyor
  ACTIVE        // Aktif
  PAUSED        // Duraklatılmış
  BANNED        // Yasaklanmış
}

model Affiliate {
  id            String          @id @default(cuid())

  userId        String          @unique

  // Referans kodu
  referralCode  String          @unique

  // Durum
  status        AffiliateStatus @default(PENDING)

  // Komisyon oranı (%)
  commissionRate Decimal        @default(10) @db.Decimal(5, 2)

  // İstatistikler
  totalClicks   Int             @default(0)
  totalSignups  Int             @default(0)
  totalSales    Int             @default(0)
  totalEarnings Decimal         @default(0) @db.Decimal(18, 2)
  pendingEarnings Decimal       @default(0) @db.Decimal(18, 2)

  // Cookie süresi (gün)
  cookieDays    Int             @default(30)

  // Ödeme bilgileri
  payoutMethod  String?
  payoutDetails Json?
  minPayoutAmount Decimal       @default(50) @db.Decimal(10, 2)

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  referrals     AffiliateReferral[]
  commissions   AffiliateCommission[]
  payouts       AffiliatePayout[]

  @@index([userId])
  @@index([referralCode])
  @@index([status])
}

model AffiliateReferral {
  id            String    @id @default(cuid())

  affiliateId   String
  affiliate     Affiliate @relation(fields: [affiliateId], references: [id], onDelete: Cascade)

  // Yönlendirilen kullanıcı
  referredUserId String?  // Kayıt olduysa
  referredEmail  String?  // Henüz kayıt olmadıysa

  // İzleme
  clickedAt     DateTime  @default(now())
  signedUpAt    DateTime?
  firstPurchaseAt DateTime?

  // Kaynak
  source        String?   // utm_source
  medium        String?   // utm_medium
  campaign      String?   // utm_campaign
  landingPage   String?

  // Meta
  ipAddress     String?
  userAgent     String?
  country       String?

  // Cookie bilgisi
  cookieId      String?
  cookieExpiresAt DateTime?

  createdAt     DateTime  @default(now())

  @@index([affiliateId])
  @@index([referredUserId])
  @@index([cookieId])
}

model AffiliateCommission {
  id            String    @id @default(cuid())

  affiliateId   String
  affiliate     Affiliate @relation(fields: [affiliateId], references: [id], onDelete: Cascade)

  // Sipariş bilgisi
  orderId       String
  orderAmount   Decimal   @db.Decimal(10, 2)

  // Komisyon
  commissionRate Decimal  @db.Decimal(5, 2)
  commissionAmount Decimal @db.Decimal(10, 2)
  currency      String    @default("EUR")

  // Durum
  status        String    @default("pending") // pending, approved, paid, cancelled

  // Onay
  approvedAt    DateTime?
  approvedBy    String?

  // Ödeme
  payoutId      String?
  paidAt        DateTime?

  // Notlar
  notes         String?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([affiliateId])
  @@index([orderId])
  @@index([status])
}

model AffiliatePayout {
  id            String    @id @default(cuid())

  affiliateId   String
  affiliate     Affiliate @relation(fields: [affiliateId], references: [id], onDelete: Cascade)

  // Tutar
  amount        Decimal   @db.Decimal(18, 2)
  fee           Decimal   @default(0) @db.Decimal(18, 2)
  netAmount     Decimal   @db.Decimal(18, 2)
  currency      String    @default("EUR")

  // Durum
  status        String    @default("pending") // pending, processing, completed, failed

  // Ödeme detayları
  payoutMethod  String
  payoutRef     String?

  // İşlem tarihleri
  requestedAt   DateTime  @default(now())
  processedAt   DateTime?
  completedAt   DateTime?

  // Notlar
  notes         String?
  failureReason String?

  @@index([affiliateId])
  @@index([status])
}

// -------------------- HOSTING & DEPLOYMENT (TEK TIKLA DEPLOY) --------------------

enum WebsiteStatus {
  CREATING      // Oluşturuluyor
  DEPLOYING     // Deploy ediliyor
  ACTIVE        // Aktif
  SUSPENDED     // Askıya alınmış
  MAINTENANCE   // Bakımda
  DELETED       // Silinmiş
}

enum WebsitePlan {
  STARTER       // 1 site, 5GB, temel
  BUSINESS      // 5 site, 50GB, premium
  AGENCY        // Sınırsız site, white-label
  ENTERPRISE    // Özel sunucu, SLA
}

model Website {
  id            String        @id @default(cuid())

  userId        String
  organizationId String?

  // Template/Product kaynak
  productId     String?       // Hangi template'den oluşturuldu
  orderId       String?       // Satın alma siparişi

  // Temel bilgiler
  name          String
  slug          String        @unique
  description   String?

  // Domain yönetimi
  subdomain     String        @unique // site.hyble.co
  customDomain  String?       @unique // www.example.com

  // Durum
  status        WebsiteStatus @default(CREATING)
  plan          WebsitePlan   @default(STARTER)

  // SSL
  sslEnabled    Boolean       @default(true)
  sslCertId     String?
  sslExpiresAt  DateTime?

  // Deployment
  containerId   String?       // Docker container ID
  serverIp      String?       // Assigned server IP
  serverPort    Int?

  // Git entegrasyonu
  gitRepo       String?
  gitBranch     String        @default("main")
  lastDeployAt  DateTime?
  lastDeployCommit String?

  // Kaynak kullanımı
  diskUsage     BigInt        @default(0) // Byte cinsinden
  bandwidthUsage BigInt       @default(0) // Aylık bandwidth (byte)

  // Limitler
  diskLimit     BigInt        @default(5368709120) // 5GB default
  bandwidthLimit BigInt       @default(107374182400) // 100GB default

  // Analytics
  pageViews     Int           @default(0)
  uniqueVisitors Int          @default(0)

  // Ayarlar
  settings      Json?         // Site-specific settings
  envVars       Json?         // Environment variables (encrypted)

  // Meta
  framework     String?       // nextjs, react, vue, static
  nodeVersion   String?

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  deletedAt     DateTime?

  domains       WebsiteDomain[]
  deployments   WebsiteDeployment[]
  backups       WebsiteBackup[]

  @@index([userId])
  @@index([organizationId])
  @@index([status])
  @@index([subdomain])
  @@index([customDomain])
}

model WebsiteDomain {
  id            String    @id @default(cuid())

  websiteId     String
  website       Website   @relation(fields: [websiteId], references: [id], onDelete: Cascade)

  domain        String    @unique

  // DNS doğrulama
  verificationToken String
  verified      Boolean   @default(false)
  verifiedAt    DateTime?

  // DNS kayıtları
  dnsRecords    Json?     // Required DNS records

  // SSL
  sslEnabled    Boolean   @default(false)
  sslAutoRenew  Boolean   @default(true)
  sslCertId     String?
  sslExpiresAt  DateTime?

  // Primary domain
  isPrimary     Boolean   @default(false)

  // Cloudflare entegrasyonu
  cloudflareZoneId String?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([websiteId])
  @@index([domain])
}

model WebsiteDeployment {
  id            String    @id @default(cuid())

  websiteId     String
  website       Website   @relation(fields: [websiteId], references: [id], onDelete: Cascade)

  // Deployment bilgileri
  deployNumber  Int       // Deployment numarası
  commitHash    String?
  commitMessage String?
  branch        String    @default("main")

  // Durum
  status        String    @default("pending") // pending, building, deploying, success, failed

  // Loglar
  buildLogs     String?   @db.Text
  deployLogs    String?   @db.Text
  errorMessage  String?

  // Süreler
  buildDuration Int?      // Saniye cinsinden
  deployDuration Int?

  // Tetikleyici
  triggeredBy   String?   // user_id, webhook, auto
  triggerType   String    @default("manual") // manual, git_push, schedule

  // Timestamps
  startedAt     DateTime  @default(now())
  buildStartAt  DateTime?
  buildEndAt    DateTime?
  deployStartAt DateTime?
  deployEndAt   DateTime?
  completedAt   DateTime?

  // Rollback için
  isRollback    Boolean   @default(false)
  rollbackFrom  String?   // Deployment ID

  createdAt     DateTime  @default(now())

  @@index([websiteId])
  @@index([status])
  @@index([createdAt])
}

model WebsiteBackup {
  id            String    @id @default(cuid())

  websiteId     String
  website       Website   @relation(fields: [websiteId], references: [id], onDelete: Cascade)

  // Backup bilgileri
  name          String
  type          String    @default("full") // full, incremental, database

  // Storage
  r2Key         String    @unique
  size          BigInt    // Byte cinsinden

  // Durum
  status        String    @default("pending") // pending, creating, completed, failed, deleted

  // Otomatik backup
  isAutomatic   Boolean   @default(false)

  // Retention
  expiresAt     DateTime?

  // Timestamps
  startedAt     DateTime  @default(now())
  completedAt   DateTime?

  createdAt     DateTime  @default(now())

  @@index([websiteId])
  @@index([status])
  @@index([expiresAt])
}

// -------------------- WaaS SUBSCRIPTION PLANS --------------------

model WaasPlan {
  id            String    @id @default(cuid())

  name          String
  slug          String    @unique
  description   String?   @db.Text

  // Fiyatlandırma
  priceMonthly  Decimal   @db.Decimal(10, 2)
  priceYearly   Decimal   @db.Decimal(10, 2)
  currency      String    @default("EUR")

  // Limitler
  maxWebsites   Int       // -1 = sınırsız
  diskSpaceGb   Int
  bandwidthGb   Int

  // Özellikler
  features      Json      // Feature list as JSON

  // White-label
  allowWhiteLabel Boolean @default(false)

  // Öncelik desteği
  supportPriority String  @default("normal") // normal, priority, dedicated

  // Görünürlük
  isPublic      Boolean   @default(true)
  isFeatured    Boolean   @default(false)
  sortOrder     Int       @default(0)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([slug])
  @@index([isPublic])
}

// -------------------- SITE BUILDER (SÜRÜKLE-BIRAK EDİTÖR) --------------------

model SitePage {
  id            String    @id @default(cuid())

  websiteId     String

  // Sayfa bilgileri
  name          String
  slug          String

  // İçerik (JSON olarak bloklar)
  content       Json      // GrapesJS veya EditorJS formatında

  // SEO
  title         String?
  metaDescription String?
  ogImage       String?

  // Durum
  isPublished   Boolean   @default(false)
  publishedAt   DateTime?

  // Şablon
  templateId    String?   // Hazır şablon kullanıldıysa

  // Sıralama
  sortOrder     Int       @default(0)

  // Anasayfa mı?
  isHomePage    Boolean   @default(false)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([websiteId, slug])
  @@index([websiteId])
}

model SiteBlock {
  id            String    @id @default(cuid())

  // Block tipi
  type          String    // hero, features, pricing, faq, contact, gallery, etc.

  // İsim ve açıklama
  name          String
  description   String?

  // Kategori
  category      String    // sections, headers, footers, forms, etc.

  // İçerik şablonu
  content       Json      // Default content structure

  // Önizleme
  thumbnail     String?
  previewUrl    String?

  // Premium mi?
  isPremium     Boolean   @default(false)

  // Aktif mi?
  isActive      Boolean   @default(true)

  sortOrder     Int       @default(0)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([type])
  @@index([category])
  @@index([isPremium])
}

// -------------------- AI WEB OLUŞTURUCU --------------------

model AiWebsiteGeneration {
  id            String    @id @default(cuid())

  userId        String
  websiteId     String?   // Oluşturulan site

  // Kullanıcı girdileri
  industry      String    // Sektör (restaurant, portfolio, ecommerce, etc.)
  businessName  String
  description   String    @db.Text

  // AI tarafından oluşturulanlar
  suggestedColors Json?   // Renk paleti
  suggestedFonts  Json?   // Font önerileri
  suggestedContent Json?  // İçerik önerileri
  suggestedImages Json?   // Görsel önerileri

  // Durum
  status        String    @default("pending") // pending, generating, completed, failed

  // AI model bilgisi
  modelUsed     String?
  tokensUsed    Int?

  // Timestamps
  startedAt     DateTime  @default(now())
  completedAt   DateTime?

  createdAt     DateTime  @default(now())

  @@index([userId])
  @@index([status])
}

// -------------------- FREELANCER/AJANS PAZARYERI --------------------

enum FreelancerStatus {
  PENDING       // Onay bekliyor
  ACTIVE        // Aktif
  SUSPENDED     // Askıya alınmış
  BANNED        // Yasaklanmış
}

enum FreelancerTier {
  STARTER       // Yeni
  RISING        // Yükselen
  TOP_RATED     // Üst düzey
  EXPERT        // Uzman
}

model Freelancer {
  id            String            @id @default(cuid())

  userId        String            @unique

  // Profil
  displayName   String
  slug          String            @unique
  title         String            // "Senior Web Developer"
  bio           String            @db.Text
  avatar        String?
  coverImage    String?

  // İletişim
  publicEmail   String?
  website       String?
  location      String?
  timezone      String?

  // Yetenekler
  skills        String[]          // ["React", "Next.js", "Tailwind"]
  languages     Json?             // [{ "lang": "en", "level": "native" }]

  // Deneyim
  yearsExperience Int             @default(0)
  portfolioUrls   String[]

  // Fiyatlandırma
  hourlyRate    Decimal?          @db.Decimal(10, 2)
  currency      String            @default("EUR")

  // Durum
  status        FreelancerStatus  @default(PENDING)
  tier          FreelancerTier    @default(STARTER)

  // Doğrulama
  isVerified    Boolean           @default(false)
  verifiedAt    DateTime?

  // İstatistikler
  totalProjects Int               @default(0)
  completedProjects Int           @default(0)
  totalEarnings Decimal           @default(0) @db.Decimal(18, 2)
  averageRating Decimal           @default(0) @db.Decimal(3, 2)
  responseTime  Int?              // Ortalama yanıt süresi (saat)

  // Availability
  isAvailable   Boolean           @default(true)
  availableFrom DateTime?

  // Sertifikalar
  certificates  Json?

  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  projects      FreelanceProject[]
  proposals     FreelanceProposal[]
  reviews       FreelanceReview[]

  @@index([userId])
  @@index([slug])
  @@index([status])
  @@index([tier])
  @@index([isAvailable])
}

enum ProjectStatus {
  DRAFT         // Taslak
  OPEN          // Teklif kabul ediyor
  IN_PROGRESS   // Devam ediyor
  REVIEW        // İnceleme aşamasında
  COMPLETED     // Tamamlandı
  CANCELLED     // İptal edildi
  DISPUTED      // Anlaşmazlık
}

model FreelanceProject {
  id            String        @id @default(cuid())

  // Proje sahibi
  clientId      String        // Müşteri user ID

  // Atanan freelancer
  freelancerId  String?
  freelancer    Freelancer?   @relation(fields: [freelancerId], references: [id])

  // Proje bilgileri
  title         String
  description   String        @db.Text
  requirements  String?       @db.Text

  // Kategori
  category      String        // web_design, development, etc.
  skills        String[]      // Gerekli yetenekler

  // Bütçe
  budgetType    String        @default("fixed") // fixed, hourly
  budgetMin     Decimal?      @db.Decimal(10, 2)
  budgetMax     Decimal?      @db.Decimal(10, 2)
  currency      String        @default("EUR")

  // Süre
  deadline      DateTime?
  estimatedDays Int?

  // Durum
  status        ProjectStatus @default(DRAFT)

  // Dosyalar
  attachments   Json?

  // Escrow
  escrowAmount  Decimal?      @db.Decimal(10, 2)
  escrowStatus  String?       // pending, funded, released, refunded

  // Tamamlanma
  startedAt     DateTime?
  completedAt   DateTime?

  // Görünürlük
  isPublic      Boolean       @default(true)

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  proposals     FreelanceProposal[]
  milestones    ProjectMilestone[]
  messages      ProjectMessage[]
  review        FreelanceReview?

  @@index([clientId])
  @@index([freelancerId])
  @@index([status])
  @@index([category])
}

model FreelanceProposal {
  id            String    @id @default(cuid())

  projectId     String
  project       FreelanceProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  freelancerId  String
  freelancer    Freelancer @relation(fields: [freelancerId], references: [id], onDelete: Cascade)

  // Teklif içeriği
  coverLetter   String    @db.Text
  proposedBudget Decimal  @db.Decimal(10, 2)
  currency      String    @default("EUR")
  estimatedDays Int

  // Durum
  status        String    @default("pending") // pending, accepted, rejected, withdrawn

  // Yanıt
  clientResponse String?
  respondedAt   DateTime?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([projectId, freelancerId])
  @@index([projectId])
  @@index([freelancerId])
  @@index([status])
}

model ProjectMilestone {
  id            String    @id @default(cuid())

  projectId     String
  project       FreelanceProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Milestone bilgileri
  title         String
  description   String?   @db.Text

  // Ödeme
  amount        Decimal   @db.Decimal(10, 2)
  currency      String    @default("EUR")

  // Sıra
  sortOrder     Int       @default(0)

  // Durum
  status        String    @default("pending") // pending, in_progress, submitted, approved, paid

  // Deadline
  dueDate       DateTime?

  // Tamamlanma
  submittedAt   DateTime?
  approvedAt    DateTime?
  paidAt        DateTime?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([projectId])
  @@index([status])
}

model ProjectMessage {
  id            String    @id @default(cuid())

  projectId     String
  project       FreelanceProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  senderId      String

  content       String    @db.Text

  // Dosya ekleri
  attachments   Json?

  // Okundu bilgisi
  isRead        Boolean   @default(false)
  readAt        DateTime?

  createdAt     DateTime  @default(now())

  @@index([projectId])
  @@index([senderId])
  @@index([createdAt])
}

model FreelanceReview {
  id            String    @id @default(cuid())

  projectId     String    @unique
  project       FreelanceProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  freelancerId  String
  freelancer    Freelancer @relation(fields: [freelancerId], references: [id], onDelete: Cascade)

  clientId      String    // Değerlendiren müşteri

  // Puanlama
  rating        Int       // 1-5

  // Detaylı puanlama
  qualityRating Int?      // İş kalitesi
  communicationRating Int? // İletişim
  timelinessRating Int?   // Zamanında teslim

  // Yorum
  title         String?
  content       String    @db.Text

  // Freelancer yanıtı
  freelancerResponse String? @db.Text
  freelancerRespondedAt DateTime?

  createdAt     DateTime  @default(now())

  @@index([freelancerId])
  @@index([clientId])
  @@index([rating])
}

// -------------------- E-TİCARET ENTEGRASYONLARI --------------------

enum PaymentGatewayType {
  STRIPE
  IYZICO
  PAYTR
  PAPARA
}

model PaymentGatewayConfig {
  id            String              @id @default(cuid())

  websiteId     String

  gateway       PaymentGatewayType

  // API anahtarları (şifreli)
  apiKey        String?             // Encrypted
  secretKey     String?             // Encrypted
  merchantId    String?

  // Test/Canlı modu
  isTestMode    Boolean             @default(true)

  // Aktif mi?
  isActive      Boolean             @default(false)

  // Ayarlar
  settings      Json?

  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  @@unique([websiteId, gateway])
  @@index([websiteId])
}

enum ShippingProvider {
  MNG
  YURTICI
  ARAS
  PTT
  UPS
  DHL
  FEDEX
  CUSTOM
}

model ShippingConfig {
  id            String           @id @default(cuid())

  websiteId     String

  provider      ShippingProvider

  // API bilgileri (şifreli)
  apiKey        String?
  secretKey     String?
  customerId    String?

  // Aktif mi?
  isActive      Boolean          @default(false)

  // Fiyatlandırma
  baseCost      Decimal?         @db.Decimal(10, 2)
  freeShippingThreshold Decimal? @db.Decimal(10, 2)

  // Ayarlar
  settings      Json?

  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  @@unique([websiteId, provider])
  @@index([websiteId])
}

// -------------------- WHITE-LABEL AJANS PANELİ --------------------

model WhiteLabelConfig {
  id            String    @id @default(cuid())

  organizationId String   @unique

  // Marka
  brandName     String
  logo          String?
  favicon       String?

  // Renkler
  primaryColor  String    @default("#f59e0b")
  secondaryColor String   @default("#f97316")

  // Domain
  customDomain  String?   @unique // builder.ajansin.com

  // Email ayarları
  fromEmail     String?
  fromName      String?

  // Footer
  footerText    String?
  copyrightText String?

  // Sosyal medya
  socialLinks   Json?

  // Özelleştirme
  customCss     String?   @db.Text
  customJs      String?   @db.Text

  // Aktif mi?
  isActive      Boolean   @default(true)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([customDomain])
}

// -------------------- ANALİTİK VE SEO ARAÇLARI --------------------

model WebsiteAnalytics {
  id            String    @id @default(cuid())

  websiteId     String

  // Tarih (günlük aggregate)
  date          DateTime  @db.Date

  // Sayfa görüntüleme
  pageViews     Int       @default(0)
  uniqueVisitors Int      @default(0)

  // Oturum bilgileri
  sessions      Int       @default(0)
  avgSessionDuration Int  @default(0) // Saniye
  bounceRate    Decimal   @default(0) @db.Decimal(5, 2)

  // Kaynak dağılımı
  sourceData    Json?     // { direct: 100, organic: 50, referral: 30 }

  // Cihaz dağılımı
  deviceData    Json?     // { desktop: 60, mobile: 35, tablet: 5 }

  // Ülke dağılımı
  countryData   Json?     // { TR: 500, US: 100, DE: 50 }

  // En çok ziyaret edilen sayfalar
  topPages      Json?     // [{ path: "/", views: 500 }]

  createdAt     DateTime  @default(now())

  @@unique([websiteId, date])
  @@index([websiteId])
  @@index([date])
}

model SeoAudit {
  id            String    @id @default(cuid())

  websiteId     String
  pageUrl       String

  // Lighthouse skorları
  performanceScore Int?
  accessibilityScore Int?
  bestPracticesScore Int?
  seoScore      Int?

  // Detaylı metrikler
  fcp           Int?      // First Contentful Paint (ms)
  lcp           Int?      // Largest Contentful Paint (ms)
  cls           Decimal?  @db.Decimal(5, 3) // Cumulative Layout Shift
  fid           Int?      // First Input Delay (ms)
  ttfb          Int?      // Time to First Byte (ms)

  // SEO kontrolleri
  hasTitle      Boolean   @default(false)
  hasMeta       Boolean   @default(false)
  hasH1         Boolean   @default(false)
  hasAltTags    Boolean   @default(false)
  hasCanonical  Boolean   @default(false)
  hasRobots     Boolean   @default(false)
  hasSitemap    Boolean   @default(false)

  // Sorunlar
  issues        Json?     // [{ type: "error", message: "..." }]

  // Öneriler
  recommendations Json?   // [{ priority: "high", message: "..." }]

  createdAt     DateTime  @default(now())

  @@index([websiteId])
  @@index([createdAt])
}

// -------------------- FORM BUILDER VE CRM --------------------

model FormBuilder {
  id            String    @id @default(cuid())

  websiteId     String

  // Form bilgileri
  name          String
  description   String?

  // Form alanları (JSON)
  fields        Json      // [{ type: "text", label: "Name", required: true }]

  // Ayarlar
  submitButtonText String @default("Gönder")
  successMessage String?
  redirectUrl   String?

  // Spam koruması
  enableCaptcha Boolean   @default(true)
  captchaType   String    @default("turnstile") // turnstile, recaptcha

  // Bildirimler
  notifyEmail   String?
  notifyWebhook String?

  // Aktif mi?
  isActive      Boolean   @default(true)

  // İstatistikler
  submissionCount Int     @default(0)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  submissions   FormSubmission[]

  @@index([websiteId])
}

model FormSubmission {
  id            String    @id @default(cuid())

  formId        String
  form          FormBuilder @relation(fields: [formId], references: [id], onDelete: Cascade)

  // Form verileri
  data          Json

  // Meta
  ipAddress     String?
  userAgent     String?
  referrer      String?

  // Durum
  isRead        Boolean   @default(false)
  readAt        DateTime?

  // Spam kontrolü
  isSpam        Boolean   @default(false)
  spamScore     Decimal?  @db.Decimal(3, 2)

  createdAt     DateTime  @default(now())

  @@index([formId])
  @@index([isRead])
  @@index([createdAt])
}

// Basit CRM - Müşteri veritabanı
model CrmContact {
  id            String    @id @default(cuid())

  websiteId     String

  // Temel bilgiler
  email         String
  firstName     String?
  lastName      String?
  phone         String?
  company       String?

  // Etiketler
  tags          String[]

  // Kaynak
  source        String?   // form, import, manual
  sourceDetails String?

  // Notlar
  notes         String?   @db.Text

  // E-posta pazarlama
  isSubscribed  Boolean   @default(false)
  subscribedAt  DateTime?
  unsubscribedAt DateTime?

  // Aktivite
  lastActivityAt DateTime?

  // Özel alanlar
  customFields  Json?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  activities    CrmActivity[]

  @@unique([websiteId, email])
  @@index([websiteId])
  @@index([email])
  @@index([tags])
}

model CrmActivity {
  id            String    @id @default(cuid())

  contactId     String
  contact       CrmContact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  // Aktivite tipi
  type          String    // form_submit, email_open, email_click, page_view, note

  // Açıklama
  description   String

  // Meta
  metadata      Json?

  createdAt     DateTime  @default(now())

  @@index([contactId])
  @@index([type])
  @@index([createdAt])
}

// ==================== FILE UPLOADS ====================

model Upload {
  id            String    @id @default(cuid())

  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Dosya bilgileri
  filename      String    // Orijinal dosya adı
  key           String    @unique // S3/R2 key
  contentType   String    // MIME type
  size          BigInt    // Byte cinsinden

  // Durum
  status        String    @default("pending") // pending, completed, failed, deleted

  // Meta
  purpose       String?   // product-image, profile-avatar, etc.
  isPublic      Boolean   @default(false)

  // Timestamps
  completedAt   DateTime?
  expiresAt     DateTime? // Geçici yüklemeler için

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([userId])
  @@index([status])
  @@index([purpose])
  @@index([key])
}

// ==================== LEAD MANAGEMENT ====================

model Lead {
  id          String    @id @default(cuid())
  email       String    @unique
  source      String    // exit_intent, newsletter, waitlist, demo_request
  lastSource  String?
  couponCode  String?
  couponUsed  Boolean   @default(false)
  convertedAt DateTime?
  userId      String?   // Kayıt olursa bağla
  metadata    Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  emailSequences EmailSequence[]

  @@index([email])
  @@index([source])
  @@index([createdAt])
}

model EmailSequence {
  id           String    @id @default(cuid())
  leadId       String
  sequenceName String    // onboarding_7day, abandoned_cart, etc.
  currentStep  Int       @default(0)
  completed    Boolean   @default(false)
  nextSendAt   DateTime?
  pausedAt     DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([nextSendAt])
  @@index([sequenceName])
}

model ABTestEvent {
  id        String   @id @default(cuid())
  testId    String
  variant   String
  converted Boolean  @default(false)
  sessionId String?
  createdAt DateTime @default(now())

  @@index([testId])
  @@index([testId, variant])
}

// ==================== REFERRAL PROGRAM ====================

model ReferralCode {
  id          String   @id @default(cuid())
  userId      String   @unique
  code        String   @unique // AHMET20, custom code
  commission  Int      @default(20) // %20 komisyon
  discount    Int      @default(20) // %20 indirim
  totalEarned Decimal  @default(0) @db.Decimal(18, 2)
  totalPaid   Decimal  @default(0) @db.Decimal(18, 2)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  referrals Referral[]

  @@index([code])
  @@index([userId])
}

model Referral {
  id              String    @id @default(cuid())
  referralCodeId  String
  referredUserId  String    @unique // Davet edilen
  status          String    @default("pending") // pending, converted, paid
  conversionValue Decimal?  @db.Decimal(18, 2) // İlk ödeme tutarı
  commission      Decimal?  @db.Decimal(18, 2) // Kazanılan komisyon
  paidAt          DateTime?
  createdAt       DateTime  @default(now())
  convertedAt     DateTime?

  referralCode ReferralCode @relation(fields: [referralCodeId], references: [id], onDelete: Cascade)

  @@index([referralCodeId])
  @@index([referredUserId])
  @@index([status])
}

model PayoutRequest {
  id        String   @id @default(cuid())
  userId    String
  amount    Decimal  @db.Decimal(18, 2)
  status    String   @default("pending") // pending, approved, rejected, paid
  method    String?  // bank_transfer, paypal, crypto
  details   Json?    // Ödeme detayları
  processedAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

// ==================== USAGE ALERTS ====================

model UsageAlert {
  id              String   @id @default(cuid())
  subscriptionId  String
  userId          String
  resource        String   // api_calls, storage, bandwidth
  threshold       Int      // 50, 80, 90, 100
  currentUsage    BigInt
  limit           BigInt
  billingPeriod   String   // 2024-01
  acknowledged    Boolean  @default(false)
  createdAt       DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([userId])
  @@index([billingPeriod])
}

// ==================== NPS SURVEY ====================

model NpsSurvey {
  id        String   @id @default(cuid())
  userId    String
  score     Int      // 0-10, -1 for skipped
  feedback  String?
  skipped   Boolean  @default(false)
  trigger   String?  // post_purchase, after_30_days, after_support
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([score])
  @@index([createdAt])
}

// ==================== TEMPLATE STORE ====================

enum TemplateCategory {
  WEBSITE           // Kurumsal, portfolyo
  ECOMMERCE         // Online mağaza
  LANDING_PAGE      // Tek sayfa, kampanya
  SAAS              // Dashboard, panel
  BLOG              // Blog, haber
  PORTFOLIO         // Kişisel portfolyo
  RESTAURANT        // Restoran, kafe
  AGENCY            // Ajans, stüdyo
}

enum TemplateStatus {
  DRAFT             // Taslak
  ACTIVE            // Satışta
  ARCHIVED          // Arşivde
}

enum TemplateFramework {
  NEXTJS            // Next.js
  REACT             // React
  HTML              // Static HTML
  WORDPRESS         // WordPress tema
}

model Template {
  id              String           @id @default(cuid())
  slug            String           @unique
  status          TemplateStatus   @default(DRAFT)

  // Temel Bilgiler
  nameTr          String
  nameEn          String
  descriptionTr   String           @db.Text
  descriptionEn   String           @db.Text
  shortDescTr     String?          // Liste görünümü için
  shortDescEn     String?

  // Kategori & Etiketler
  category        TemplateCategory
  tags            String[]         // ["modern", "minimal", "dark"]
  industry        String[]         // ["teknoloji", "sağlık", "eğitim"]

  // Fiyatlandırma
  price           Decimal          @db.Decimal(10, 2)
  comparePrice    Decimal?         @db.Decimal(10, 2)  // İndirim öncesi fiyat
  currency        String           @default("EUR")

  // Framework & Teknik
  framework       TemplateFramework
  version         String           @default("1.0.0")
  features        String[]         // ["responsive", "dark-mode", "seo-ready"]
  techStack       String[]         // ["tailwind", "framer-motion", "prisma"]

  // Görseller
  thumbnail       String           // Ana görsel
  images          String[]         // Galeri görselleri
  previewUrl      String?          // Canlı demo linki

  // Dosyalar
  downloadUrl     String?          // Kaynak dosya (protected)
  documentationUrl String?         // Kurulum dokümanı

  // İstatistikler
  salesCount      Int              @default(0)
  viewCount       Int              @default(0)
  rating          Decimal          @default(0) @db.Decimal(2, 1)
  reviewCount     Int              @default(0)

  // Öne Çıkarma
  isFeatured      Boolean          @default(false)
  featuredOrder   Int?
  isNew           Boolean          @default(true)

  // Cloud Entegrasyonu
  cloudCompatible Boolean          @default(true)
  deployTime      Int              @default(60)      // Saniye cinsinden tahmini kurulum

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  // Relations
  purchases       TemplatePurchase[]
  reviews         TemplateReview[]
  deployments     TemplateDeployment[]

  @@index([category])
  @@index([status])
  @@index([isFeatured])
  @@index([salesCount])
  @@index([slug])
}

model TemplatePurchase {
  id              String   @id @default(cuid())
  templateId      String
  userId          String

  // Ödeme
  amount          Decimal  @db.Decimal(10, 2)
  currency        String   @default("EUR")
  transactionId   String?

  // Lisans
  licenseKey      String   @unique @default(cuid())
  licenseType     String   @default("standard")  // standard, extended

  // Durum
  downloadCount   Int      @default(0)
  maxDownloads    Int      @default(5)
  expiresAt       DateTime?

  createdAt       DateTime @default(now())

  template        Template @relation(fields: [templateId], references: [id])
  deployments     TemplateDeployment[]

  @@unique([templateId, userId])
  @@index([userId])
  @@index([templateId])
}

model TemplateReview {
  id          String   @id @default(cuid())
  templateId  String
  userId      String

  rating      Int      // 1-5
  title       String?
  content     String?  @db.Text

  isVerified  Boolean  @default(false)  // Satın almış mı
  isApproved  Boolean  @default(false)  // Admin onayı

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  template    Template @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, userId])
  @@index([templateId])
  @@index([rating])
}

model TemplateDeployment {
  id              String   @id @default(cuid())
  templateId      String
  purchaseId      String
  userId          String

  // Deployment Bilgileri
  projectName     String
  subdomain       String   @unique  // projectname.hyble.co
  customDomain    String?

  // Cloud Kaynakları
  serverId        String?           // Hyble Cloud VPS ID
  databaseId      String?           // Managed DB ID

  // Durum
  status          String   @default("pending")  // pending, deploying, active, failed, suspended
  deployedAt      DateTime?
  lastDeployAt    DateTime?

  // Wizard Config
  config          Json?             // Kullanıcı ayarları (logo, renkler, vs.)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  template        Template         @relation(fields: [templateId], references: [id])
  purchase        TemplatePurchase @relation(fields: [purchaseId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([subdomain])
}

// ==================== BLOG ====================

enum BlogPostStatus {
  DRAFT
  SCHEDULED
  PUBLISHED
  ARCHIVED
}

enum BlogPostVertical {
  GENERAL    // Hyble genel
  DIGITAL    // Hyble Digital
  STUDIOS    // Hyble Studios
}

model BlogCategory {
  id          String   @id @default(cuid())
  slug        String   @unique

  // i18n Content
  nameTr      String
  nameEn      String
  descTr      String?
  descEn      String?

  // Görsel
  icon        String?  // Lucide icon name
  color       String?  // Tailwind color (amber, emerald, sky)

  // Hiyerarşi
  parentId    String?
  parent      BlogCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    BlogCategory[] @relation("CategoryHierarchy")

  // Sıralama
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)

  // Audit
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  posts       BlogPost[]

  @@index([slug])
  @@index([parentId])
  @@index([isActive])
}

model BlogPost {
  id            String          @id @default(cuid())
  slug          String          @unique
  status        BlogPostStatus  @default(DRAFT)
  vertical      BlogPostVertical @default(GENERAL)

  // i18n Content
  titleTr       String
  titleEn       String
  excerptTr     String?         @db.Text
  excerptEn     String?         @db.Text
  contentTr     String          @db.Text
  contentEn     String          @db.Text

  // Kategori & Etiketler
  categoryId    String?
  category      BlogCategory?   @relation(fields: [categoryId], references: [id])
  tags          String[]        // ["tutorial", "news", "feature", "update"]

  // Görsel
  featuredImage String?
  thumbnail     String?
  gallery       String[]        // Ek görseller

  // SEO
  metaTitleTr   String?
  metaTitleEn   String?
  metaDescTr    String?
  metaDescEn    String?
  canonicalUrl  String?

  // Okuma Metrikleri
  readingTime   Int             @default(5)  // Dakika
  wordCount     Int             @default(0)

  // Yayın Bilgileri
  authorId      String?
  authorName    String?         // Denormalized for display
  authorImage   String?
  publishedAt   DateTime?
  scheduledAt   DateTime?

  // İstatistikler
  viewCount     Int             @default(0)
  likeCount     Int             @default(0)
  shareCount    Int             @default(0)

  // İlişkili İçerik
  relatedPosts  String[]        // Post IDs

  // Öne Çıkarma
  isFeatured    Boolean         @default(false)
  isPinned      Boolean         @default(false)

  // Audit
  createdBy     String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([slug])
  @@index([status])
  @@index([vertical])
  @@index([categoryId])
  @@index([publishedAt])
  @@index([isFeatured])
  @@index([isPinned])
}

// -------------------- CMS PAGE --------------------
// Statik içerik sayfaları (About, Terms, Privacy, etc.)

enum CmsPageStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model CmsPage {
  id              String        @id @default(cuid())
  slug            String        @unique
  status          CmsPageStatus @default(DRAFT)

  // Content
  title           String
  description     String?       @db.Text
  content         String        @db.Text

  // SEO
  metaTitle       String?
  metaDescription String?

  // Audit
  authorId        String
  publishedAt     DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([slug])
  @@index([status])
}

// ==================== HYBLEBILLING CORE ====================

// -------------------- BILLING CUSTOMER --------------------
// User ile ilişkilendirilmiş billing müşterisi
model BillingCustomer {
  id              String              @id @default(cuid())

  // User ile ilişki
  userId          String              @unique

  // Billing bilgileri
  email           String
  firstName       String
  lastName        String
  companyName     String?

  // Vergi bilgileri
  taxId           String?             // TCKN veya VKN
  vatNumber       String?             // AB VAT numarası
  taxExempt       Boolean             @default(false)

  // Tercihler
  currencyCode    String              @default("EUR")
  language        String              @default("tr")
  timezone        String              @default("Europe/Istanbul")

  // Konum
  country         String?

  // Durum
  status          CustomerStatus      @default(ACTIVE)

  // Meta
  metadata        Json?

  // İlişkiler
  addresses       BillingAddress[]
  services        BillingService[]
  invoices        BillingInvoice[]
  paymentTokens   BillingPaymentToken[]
  billingWallet   BillingWallet?

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([email])
  @@index([status])
}

enum CustomerStatus {
  ACTIVE
  SUSPENDED
  CLOSED
  PENDING
}

model BillingAddress {
  id            String              @id @default(cuid())

  customerId    String
  customer      BillingCustomer     @relation(fields: [customerId], references: [id], onDelete: Cascade)

  type          String              @default("billing") // billing, shipping

  line1         String
  line2         String?
  city          String
  state         String?
  postalCode    String
  country       String

  isDefault     Boolean             @default(false)

  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  @@index([customerId])
}

// -------------------- BILLING SERVICES --------------------
// Müşteriye sağlanan servisler (abonelikler, lisanslar vb.)

enum BillingServiceStatus {
  PENDING
  ACTIVE
  SUSPENDED
  TERMINATED
  CANCELLED
}

enum BillingCycle {
  ONE_TIME
  MONTHLY
  QUARTERLY
  SEMI_ANNUALLY
  ANNUALLY
  BIENNIALLY
  TRIENNIALLY
}

model BillingService {
  id              String                  @id @default(cuid())

  // İlişkiler
  customerId      String
  customer        BillingCustomer         @relation(fields: [customerId], references: [id])

  productId       String

  // Tanımlayıcı
  identifier      String?                 // Domain, server adı vb.

  // Vertical
  vertical        String                  @default("hyble") // hyble, gaming, digital

  // Faturalama
  billingCycle    BillingCycle
  amount          Decimal                 @db.Decimal(10, 2)
  currencyCode    String

  // Tarihler
  startDate       DateTime                @default(now())
  nextDueDate     DateTime
  terminationDate DateTime?

  // Durum
  status          BillingServiceStatus    @default(PENDING)

  // Abonelik ilişkisi
  subscriptionId  String?                 @unique

  // Konfigürasyon
  configOptions   Json?

  // Provisioning verisi
  provisioningData Json?                  // Credentials, IP'ler vb.

  // Notlar
  adminNotes      String?

  // Fatura kalemleri
  invoiceItems    BillingInvoiceItem[]

  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt

  @@index([customerId])
  @@index([status])
  @@index([nextDueDate])
  @@index([vertical])
}

// -------------------- BILLING INVOICES --------------------

enum BillingInvoiceStatus {
  DRAFT
  PENDING
  PAID
  PARTIALLY_PAID
  OVERDUE
  CANCELLED
  REFUNDED
}

model BillingInvoice {
  id              String                  @id @default(cuid())
  invoiceNumber   String                  @unique

  // Müşteri
  customerId      String
  customer        BillingCustomer         @relation(fields: [customerId], references: [id])

  // Tutarlar
  subtotal        Decimal                 @db.Decimal(10, 2)
  taxTotal        Decimal                 @db.Decimal(10, 2) @default(0)
  discount        Decimal                 @db.Decimal(10, 2) @default(0)
  total           Decimal                 @db.Decimal(10, 2)
  amountPaid      Decimal                 @db.Decimal(10, 2) @default(0)
  balance         Decimal                 @db.Decimal(10, 2)

  // Para birimi
  currencyCode    String
  exchangeRate    Decimal                 @db.Decimal(10, 6) @default(1)

  // Durum
  status          BillingInvoiceStatus    @default(DRAFT)

  // Tarihler
  issueDate       DateTime                @default(now())
  dueDate         DateTime
  paidDate        DateTime?

  // Notlar
  notes           String?
  adminNotes      String?

  // Fatura adresi snapshot
  billingAddress  Json?

  // İlişkiler
  items           BillingInvoiceItem[]
  payments        BillingPayment[]

  // Kupon
  couponId        String?
  couponCode      String?

  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt

  @@index([customerId])
  @@index([status])
  @@index([dueDate])
  @@index([invoiceNumber])
}

model BillingInvoiceItem {
  id            String              @id @default(cuid())

  invoiceId     String
  invoice       BillingInvoice      @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  // Servis referansı
  serviceId     String?
  service       BillingService?     @relation(fields: [serviceId], references: [id])

  // Detaylar
  description   String
  quantity      Int                 @default(1)
  unitPrice     Decimal             @db.Decimal(10, 2)

  // Vergi
  taxable       Boolean             @default(true)
  taxRate       Decimal             @db.Decimal(5, 2) @default(0)
  taxAmount     Decimal             @db.Decimal(10, 2) @default(0)

  // İndirim
  discountAmount Decimal            @db.Decimal(10, 2) @default(0)

  // Toplamlar
  subtotal      Decimal             @db.Decimal(10, 2)
  total         Decimal             @db.Decimal(10, 2)

  // Faturalama dönemi
  periodStart   DateTime?
  periodEnd     DateTime?

  createdAt     DateTime            @default(now())

  @@index([invoiceId])
  @@index([serviceId])
}

// -------------------- BILLING PAYMENTS --------------------

enum BillingPaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum BillingPaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  BANK_TRANSFER
  PAYPAL
  WALLET
  MANUAL
  IYZICO
}

model BillingPaymentGateway {
  id                  String    @id @default(cuid())

  name                String
  slug                String    @unique

  // Durum
  isActive            Boolean   @default(false)
  isDefault           Boolean   @default(false)
  testMode            Boolean   @default(true)

  // Kimlik bilgileri (encrypted JSON)
  credentials         Json

  // Özellikler
  supportsTokenization Boolean  @default(false)
  supportsRefund      Boolean   @default(true)
  supportsRecurring   Boolean   @default(false)

  // Desteklenen para birimleri
  supportedCurrencies String[]  @default(["TRY"])

  // İlişkiler
  payments            BillingPayment[]
  tokens              BillingPaymentToken[]

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
}

model BillingPaymentToken {
  id            String                  @id @default(cuid())

  customerId    String
  customer      BillingCustomer         @relation(fields: [customerId], references: [id], onDelete: Cascade)

  gatewayId     String
  gateway       BillingPaymentGateway   @relation(fields: [gatewayId], references: [id])

  // Token
  token         String

  // Kart bilgileri (masked)
  cardLast4     String
  cardBrand     String
  cardExpMonth  Int
  cardExpYear   Int
  cardholderName String?

  // Fatura adresi
  billingAddress Json?

  // Durum
  isDefault     Boolean                 @default(false)
  isActive      Boolean                 @default(true)

  // İlişkiler
  payments      BillingPayment[]

  createdAt     DateTime                @default(now())
  updatedAt     DateTime                @updatedAt

  @@index([customerId])
}

model BillingPayment {
  id              String                  @id @default(cuid())

  // İlişkiler
  invoiceId       String
  invoice         BillingInvoice          @relation(fields: [invoiceId], references: [id])

  customerId      String

  // Tutar
  amount          Decimal                 @db.Decimal(10, 2)
  currencyCode    String

  // Gateway
  gatewayId       String
  gateway         BillingPaymentGateway   @relation(fields: [gatewayId], references: [id])
  gatewayTxnId    String?

  // Ödeme token'ı
  paymentTokenId  String?
  paymentToken    BillingPaymentToken?    @relation(fields: [paymentTokenId], references: [id])

  // Yöntem ve durum
  paymentMethod   BillingPaymentMethod
  status          BillingPaymentStatus    @default(PENDING)

  // Kart bilgileri
  cardLast4       String?
  cardBrand       String?

  // Ücretler
  gatewayFee      Decimal                 @db.Decimal(10, 2) @default(0)

  // İadeler
  refundedAmount  Decimal                 @db.Decimal(10, 2) @default(0)
  refunds         BillingRefund[]

  // Meta
  metadata        Json?

  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt

  @@index([invoiceId])
  @@index([customerId])
  @@index([status])
  @@index([gatewayTxnId])
}

model BillingRefund {
  id            String              @id @default(cuid())

  paymentId     String
  payment       BillingPayment      @relation(fields: [paymentId], references: [id])

  amount        Decimal             @db.Decimal(10, 2)
  reason        String?

  // Gateway
  gatewayRefundId String?

  // Durum
  status        String              @default("pending") // pending, completed, failed

  // Admin
  processedBy   String?
  processedAt   DateTime?

  createdAt     DateTime            @default(now())

  @@index([paymentId])
}

// -------------------- TAX ENGINE --------------------

model TaxRule {
  id            String    @id @default(cuid())

  name          String

  // Konum eşleştirme
  country       String?   // ISO kod, null = tümü
  state         String?

  // Oran
  rate          Decimal   @db.Decimal(5, 2)

  // Davranış
  isInclusive   Boolean   @default(false)
  isCompound    Boolean   @default(false)
  priority      Int       @default(0)

  isActive      Boolean   @default(true)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([country])
}

model TaxExemption {
  id            String    @id @default(cuid())

  customerId    String    @unique

  taxNumber     String?   // VAT numarası
  isVerified    Boolean   @default(false)
  verifiedAt    DateTime?

  exemptionType String    // VAT_REGISTERED, NON_PROFIT, etc.

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// -------------------- CURRENCY --------------------

model BillingCurrency {
  id              String    @id @default(cuid())

  code            String    @unique
  name            String
  symbol          String

  // Format
  decimalPlaces   Int       @default(2)
  symbolPosition  String    @default("before")
  thousandsSep    String    @default(",")
  decimalSep      String    @default(".")

  // Döviz kuru (base = EUR)
  exchangeRate    Decimal   @db.Decimal(10, 6) @default(1)
  lastUpdated     DateTime  @default(now())

  isDefault       Boolean   @default(false)
  isActive        Boolean   @default(true)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

// -------------------- BILLING WALLET (Hyble Credits) --------------------

model BillingWallet {
  id            String                      @id @default(cuid())

  customerId    String                      @unique
  customer      BillingCustomer             @relation(fields: [customerId], references: [id])

  // Bakiye
  balance       Decimal                     @db.Decimal(10, 2) @default(0)

  // Promo bakiyesi (ayrı, süreli)
  promoBalance  Decimal                     @db.Decimal(10, 2) @default(0)

  // Otomatik yükleme
  autoTopUpEnabled    Boolean               @default(false)
  autoTopUpAmount     Decimal?              @db.Decimal(10, 2)
  autoTopUpThreshold  Decimal?              @db.Decimal(10, 2)
  autoTopUpTokenId    String?

  // İşlemler
  transactions  BillingWalletTransaction[]

  createdAt     DateTime                    @default(now())
  updatedAt     DateTime                    @updatedAt
}

enum BillingWalletTxType {
  CREDIT
  DEBIT
  REFUND
  PROMO
  ADJUSTMENT
}

model BillingWalletTransaction {
  id            String                  @id @default(cuid())

  walletId      String
  wallet        BillingWallet           @relation(fields: [walletId], references: [id])

  // Tür
  type          BillingWalletTxType

  // Tutar
  amount        Decimal                 @db.Decimal(10, 2)
  balanceBefore Decimal                 @db.Decimal(10, 2)
  balanceAfter  Decimal                 @db.Decimal(10, 2)

  // Referans
  referenceType String?                 // Invoice, TopUp, Promo
  referenceId   String?

  // Açıklama
  description   String?

  createdAt     DateTime                @default(now())

  @@index([walletId])
  @@index([createdAt])
}

model CreditPackage {
  id            String   @id @default(cuid())

  name          String

  // Tutar
  creditAmount  Decimal  @db.Decimal(10, 2)
  price         Decimal  @db.Decimal(10, 2)

  // Bonus
  bonusAmount   Decimal  @db.Decimal(10, 2) @default(0)

  currencyCode  String

  isActive      Boolean  @default(true)
  isFeatured    Boolean  @default(false)
  sortOrder     Int      @default(0)

  createdAt     DateTime @default(now())
}

// -------------------- WEBHOOKS & EVENTS --------------------

model BillingWebhookEndpoint {
  id            String    @id @default(cuid())

  url           String
  secret        String    // İmza doğrulama için

  // Gönderilecek eventler
  events        String[]  @default([])

  // Durum
  isActive      Boolean   @default(true)

  // İstatistikler
  lastCalledAt  DateTime?
  failureCount  Int       @default(0)

  // Loglar
  logs          BillingWebhookLog[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model BillingWebhookLog {
  id            String                  @id @default(cuid())

  endpointId    String
  endpoint      BillingWebhookEndpoint  @relation(fields: [endpointId], references: [id], onDelete: Cascade)

  event         String
  payload       Json

  // Yanıt
  statusCode    Int?
  responseBody  String?

  // Durum
  success       Boolean
  error         String?

  // Zamanlama
  duration      Int?            // ms

  createdAt     DateTime        @default(now())

  @@index([endpointId])
  @@index([event])
  @@index([createdAt])
}

// -------------------- AUDIT LOG --------------------

model BillingAuditLog {
  id            String   @id @default(cuid())

  // Aktör
  actorType     String   // customer, admin, system
  actorId       String?

  // Aksiyon
  action        String   // invoice.created, payment.completed, vb.

  // Hedef
  resourceType  String   // Invoice, Payment, Service
  resourceId    String

  // Değişiklikler
  previousData  Json?
  newData       Json?

  // Bağlam
  ipAddress     String?
  userAgent     String?

  createdAt     DateTime @default(now())

  @@index([resourceType, resourceId])
  @@index([actorId])
  @@index([action])
  @@index([createdAt])
}

// -------------------- SYSTEM SETTINGS --------------------

model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
}

// ==================== INFRASTRUCTURE & DEPLOYMENT ====================

// Backup management
model Backup {
  id          String   @id @default(cuid())
  type        String   // full, incremental, database, files, config
  status      String   // pending, in_progress, completed, failed
  startedAt   DateTime
  completedAt DateTime?
  size        Int?     // bytes
  path        String?  // storage path
  error       String?
  metadata    Json?
  fingerprint String?  @unique

  createdAt   DateTime @default(now())

  @@index([type])
  @@index([status])
  @@index([startedAt])
}

// Error logging
model ErrorLog {
  id          String   @id @default(cuid())
  message     String   @db.Text
  stack       String?  @db.Text
  category    String   // runtime, database, network, auth, validation, payment, external, unknown
  severity    String   // low, medium, high, critical
  context     Json?    // request context
  fingerprint String   @unique
  occurredAt  DateTime
  resolved    Boolean  @default(false)
  resolvedAt  DateTime?
  count       Int      @default(1)
  metadata    Json?

  @@index([category])
  @@index([severity])
  @@index([resolved])
  @@index([occurredAt])
  @@index([fingerprint])
}

// Audit logging
model AuditLog {
  id           String   @id @default(cuid())
  eventType    String   // auth.login, data.create, admin.action, etc.
  severity     String   // info, warning, error, critical
  userId       String?
  actorType    String?  // user, admin, system, api
  resourceType String?
  resourceId   String?
  action       String?
  details      Json?
  previousData Json?
  newData      Json?
  ipAddress    String?
  userAgent    String?
  sessionId    String?
  correlationId String?

  createdAt    DateTime @default(now())

  @@index([eventType])
  @@index([userId])
  @@index([resourceType, resourceId])
  @@index([severity])
  @@index([createdAt])
}

// Rate limit tracking
model RateLimitEntry {
  id          String   @id @default(cuid())
  identifier  String   // IP or user ID
  windowStart DateTime
  count       Int      @default(0)
  blocked     Boolean  @default(false)
  blockedAt   DateTime?
  blockedUntil DateTime?

  @@unique([identifier, windowStart])
  @@index([identifier])
  @@index([blocked])
}

// Deployment history
model Deployment {
  id           String   @id @default(cuid())
  status       String   // pending, building, deploying, running, failed, rolled_back, completed
  target       String   // production, staging, preview
  apps         String[] // core, gateway, digital, studios, console
  branch       String?
  commit       String?
  previousVersion String?
  logs         String[] @default([])
  errors       String[] @default([])
  startedAt    DateTime
  completedAt  DateTime?
  duration     Int?     // ms

  triggeredBy  String?  // user ID or 'system'

  createdAt    DateTime @default(now())

  @@index([status])
  @@index([target])
  @@index([startedAt])
}

// Health check results
model HealthCheck {
  id          String   @id @default(cuid())
  status      String   // healthy, degraded, unhealthy
  app         String   // core, gateway, etc.
  checks      Json     // individual check results
  responseTime Int?    // ms

  checkedAt   DateTime @default(now())

  @@index([app])
  @@index([status])
  @@index([checkedAt])
}

// Feature flags
model FeatureFlag {
  id          String   @id @default(cuid())
  key         String   @unique
  name        String
  description String?
  enabled     Boolean  @default(false)
  environments String[] @default([]) // production, staging, development
  rules       Json?    // targeting rules
  rolloutPercentage Int @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([key])
  @@index([enabled])
}

// Scheduled jobs
model ScheduledJob {
  id           String   @id @default(cuid())
  name         String   @unique
  description  String?
  schedule     String   // cron expression
  handler      String   // function/handler name
  enabled      Boolean  @default(true)
  lastRun      DateTime?
  lastStatus   String?  // success, failed
  lastError    String?
  nextRun      DateTime?
  metadata     Json?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([name])
  @@index([enabled])
  @@index([nextRun])
}
